
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Custom Models &#8212; From Statistics to Statistical Learning</title>
    
  <link href="../_static/css/theme.css" rel="stylesheet" />
  <link href="../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.0/dist/embed-amd.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://integzz.github.io/excss-stats/handson-dl/103-custom-models.html" />
    <link rel="shortcut icon" href="../_static/logo.png"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Probability and Counting" href="../probability/01-Probability-and-Counting.html" />
    <link rel="prev" title="Introduction to Artificial Neural Networks with Keras" href="101-intro-keras.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">From Statistics to Statistical Learning</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../intro.html">
   From Statistics to Statistical Learning
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  HandsON
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/02-data-processing.html">
   Data Processing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/04-linear-models.html">
   Linear Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/05-support-vector-machines.html">
   Support Vector Machines
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/06-decision-trees.html">
   Decision Trees
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/07-ensemble-learning.html">
   Ensemble Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../handson/08-dimensionality-reduction.html">
   Dimensionality Reduction
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  HandsON DL
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="101-intro-keras.html">
   Introduction to Artificial Neural Networks with Keras
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Custom Models
  </a>
 </li>
</ul>
<p class="caption">
 <span class="caption-text">
  Probablity
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/01-Probability-and-Counting.html">
   Probability and Counting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/02-Conditional-Probability.html">
   Conditional Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/03-Random-Variables-and-their-Distributions.html">
   Random Variables and their Distributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/04-Expectation.html">
   Expectation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/05-Continuous-Random-Variables.html">
   Continuous Random Variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/06-Moments.html">
   Moments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/07-Joint-Distributions.html">
   Joint Distributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/08-Transformations.html">
   Transformations
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/09-Conditional-Expectation.html">
   Conditional Expectation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/10-Inequalities-and-Limit-Theorems.html">
   Inequalities and Limit Theorems
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/11-Markov-Chains.html">
   Markov Chains
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/12-Markov-Chain-Monte-Carlo.html">
   Markov Chain Monte Carlo
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/13-Poisson-Processes.html">
   Poisson Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/14-Sampling.html">
   Sampling
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/15-Parameter-Testing.html">
   Parameter Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/16-Non-Parameter-Testing.html">
   Non Parameter Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../probability/17-Survival-Analysis.html">
   Survival Analysis
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../_sources/handson-dl/103-custom-models.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/integzz/excss-stats/"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/integzz/excss-stats//issues/new?title=Issue%20on%20page%20%2Fhandson-dl/103-custom-models.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/integzz/excss-stats/master?urlpath=lab/tree/handson-dl/103-custom-models.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        <a class="colab-button" href="https://colab.research.google.com/github/integzz/excss-stats/blob/master/handson-dl/103-custom-models.ipynb"><button type="button" class="btn btn-secondary topbarbtn"
                title="Launch Colab" data-toggle="tooltip" data-placement="left"><img class="colab-button-logo"
                    src="../_static/images/logo_colab.png"
                    alt="Interact on Colab">Colab</button></a>
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Custom Models
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tensors-and-operations">
     Tensors and operations
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tensors">
       Tensors
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#indexing">
       Indexing
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ops">
       Ops
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-keras-backend">
       Using
       <code class="docutils literal notranslate">
        <span class="pre">
         keras.backend
        </span>
       </code>
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#from-to-numpy">
       From/To NumPy
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#conflicting-types">
       Conflicting Types
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#strings">
       Strings
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#string-arrays">
       String arrays
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#ragged-tensors">
       Ragged tensors
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sparse-tensors">
       Sparse tensors
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#sets">
       Sets
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#variables">
       Variables
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tensor-arrays">
       Tensor Arrays
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-loss-function">
     Custom loss function
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#saving-loading-models-with-custom-objects">
     Saving/Loading Models with Custom Objects
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#other-custom-functions">
     Other Custom Functions
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-metrics">
     Custom Metrics
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#streaming-metrics">
       Streaming metrics
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-layers">
     Custom Layers
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Custom Models
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#losses-and-metrics-based-on-model-internals">
     Losses and Metrics Based on Model Internals
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#computing-gradients-with-autodiff">
     Computing Gradients with Autodiff
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#computing-gradients-using-autodiff">
   Computing Gradients Using Autodiff
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#tensorflow-functions">
     TensorFlow Functions
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tf-functions-and-concrete-functions">
       TF Functions and Concrete Functions
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#exploring-function-definitions-and-graphs">
       Exploring Function Definitions and Graphs
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#how-tf-functions-trace-python-functions-to-extract-their-computation-graphs">
       How TF Functions Trace Python Functions to Extract Their Computation Graphs
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#using-autograph-to-capture-control-flow">
       Using Autograph To Capture Control Flow
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#handling-variables-and-other-resources-in-tf-functions">
       Handling Variables and Other Resources in TF Functions
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-tf-functions-with-tf-keras-or-not">
     Using TF Functions with tf.keras (or Not)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#custom-optimizers">
     Custom Optimizers
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implement-a-custom-layer-that-performs-layer-normalization">
   12. Implement a custom layer that performs
   <em>
    Layer Normalization
   </em>
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#a">
     a.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#b">
     b.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#c">
     c.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset">
     13. Train a model using a custom training loop to tackle the Fashion MNIST dataset
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       a.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       b.
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="custom-models">
<h1>Custom Models<a class="headerlink" href="#custom-models" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tensorflow.keras</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">import</span> <span class="nn">tensorflow</span> <span class="k">as</span> <span class="nn">tf</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="tensors-and-operations">
<h2>Tensors and operations<a class="headerlink" href="#tensors-and-operations" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tensors">
<h3>Tensors<a class="headerlink" href="#tensors" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span> <span class="c1"># matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-09 13:28:39.459199: I tensorflow/core/platform/cpu_feature_guard.cc:142] This TensorFlow binary is optimized with oneAPI Deep Neural Network Library (oneDNN) to use the following CPU instructions in performance-critical operations:  SSE4.1 SSE4.2 AVX AVX2 FMA
To enable them in other operations, rebuild TensorFlow with the appropriate compiler flags.
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># scalar</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=42&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span>
<span class="n">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>TensorShape([2, 3])
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">dtype</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tf.float32
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="indexing">
<h3>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
array([[2., 3.],
       [5., 6.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 1), dtype=float32, numpy=
array([[2.],
       [5.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ops">
<h3>Ops<a class="headerlink" href="#ops" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">+</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[11., 12., 13.],
       [14., 15., 16.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=float32, numpy=
array([[ 1.,  4.,  9.],
       [16., 25., 36.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span> <span class="o">@</span> <span class="n">tf</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=float32, numpy=
array([[14., 32.],
       [32., 77.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-keras-backend">
<h3>Using <code class="docutils literal notranslate"><span class="pre">keras.backend</span></code><a class="headerlink" href="#using-keras-backend" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">K</span> <span class="o">=</span> <span class="n">backend</span>
<span class="n">K</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">K</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">+</span> <span class="mi">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[11., 26.],
       [14., 35.],
       [19., 46.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="from-to-numpy">
<h3>From/To NumPy<a class="headerlink" href="#from-to-numpy" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">])</span>
<span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3,), dtype=float64, numpy=array([2., 4., 5.])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[1., 2., 3.],
       [4., 5., 6.]], dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3,), dtype=float64, numpy=array([ 4., 16., 25.])&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([[ 1.,  4.,  9.],
       [16., 25., 36.]], dtype=float32)
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="conflicting-types">
<h3>Conflicting Types<a class="headerlink" href="#conflicting-types" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>
<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cannot compute AddV2 as input #1(zero-based) was expected to be a float tensor but is a int32 tensor [Op:AddV2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">40.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>cannot compute AddV2 as input #1(zero-based) was expected to be a float tensor but is a double tensor [Op:AddV2]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">t2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">40.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=42.0&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="strings">
<h3>Strings<a class="headerlink" href="#strings" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;hello world&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=string, numpy=b&#39;hello world&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="s2">&quot;café&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=string, numpy=b&#39;caf\xc3\xa9&#39;&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">u</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="nb">ord</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="s2">&quot;café&quot;</span><span class="p">])</span>
<span class="n">u</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([ 99,  97, 102, 233], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">b</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">unicode_encode</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;UTF8_CHAR&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=4&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">unicode_decode</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([ 99,  97, 102, 233], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="string-arrays">
<h3>String arrays<a class="headerlink" href="#string-arrays" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="s2">&quot;Café&quot;</span><span class="p">,</span> <span class="s2">&quot;Coffee&quot;</span><span class="p">,</span> <span class="s2">&quot;caffè&quot;</span><span class="p">,</span> <span class="s2">&quot;咖啡&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">length</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;UTF8_CHAR&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4,), dtype=int32, numpy=array([4, 6, 5, 2], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">unicode_decode</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;UTF8&quot;</span><span class="p">)</span>
<span class="n">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857]]&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857]]&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="ragged-tensors">
<h3>Ragged tensors<a class="headerlink" href="#ragged-tensors" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>tf.Tensor([ 67 111 102 102 101 101], shape=(6,), dtype=int32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.RaggedTensor [[67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232]]&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ragged</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">67</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">r2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.RaggedTensor [[67, 97, 102, 233], [67, 111, 102, 102, 101, 101], [99, 97, 102, 102, 232], [21654, 21857], [65, 66], [], [67]]&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">ragged</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">68</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">70</span><span class="p">],</span> <span class="p">[</span><span class="mi">71</span><span class="p">],</span> <span class="p">[],</span> <span class="p">[</span><span class="mi">72</span><span class="p">,</span> <span class="mi">73</span><span class="p">]])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">r</span><span class="p">,</span> <span class="n">r3</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.RaggedTensor [[67, 97, 102, 233, 68, 69, 70], [67, 111, 102, 102, 101, 101, 71], [99, 97, 102, 102, 232], [21654, 21857, 72, 73]]&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">unicode_encode</span><span class="p">(</span><span class="n">r3</span><span class="p">,</span> <span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4,), dtype=string, numpy=array([b&#39;DEF&#39;, b&#39;G&#39;, b&#39;&#39;, b&#39;HI&#39;], dtype=object)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r</span><span class="o">.</span><span class="n">to_tensor</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(4, 6), dtype=int32, numpy=
array([[   67,    97,   102,   233,     0,     0],
       [   67,   111,   102,   102,   101,   101],
       [   99,    97,   102,   102,   232,     0],
       [21654, 21857,     0,     0,     0,     0]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sparse-tensors">
<h3>Sparse tensors<a class="headerlink" href="#sparse-tensors" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]],</span>
                    <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span>
                    <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SparseTensor(indices=tf.Tensor(
[[0 1]
 [1 0]
 [2 3]], shape=(3, 2), dtype=int64), values=tf.Tensor([1. 2. 3.], shape=(3,), dtype=float32), dense_shape=tf.Tensor([3 4], shape=(2,), dtype=int64))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 4), dtype=float32, numpy=
array([[0., 1., 0., 0.],
       [2., 0., 0., 0.],
       [0., 0., 0., 3.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s2</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">s3</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mf">1.</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>unsupported operand type(s) for +: &#39;SparseTensor&#39; and &#39;float&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s4</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">20.</span><span class="p">],</span> <span class="p">[</span><span class="mf">30.</span><span class="p">,</span> <span class="mf">40.</span><span class="p">],</span> <span class="p">[</span><span class="mf">50.</span><span class="p">,</span> <span class="mf">60.</span><span class="p">],</span> <span class="p">[</span><span class="mf">70.</span><span class="p">,</span> <span class="mf">80.</span><span class="p">]])</span>
<span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">sparse_dense_matmul</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">s4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[ 30.,  40.],
       [ 20.,  40.],
       [210., 240.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s5</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">SparseTensor</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]],</span>
                     <span class="n">values</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">],</span>
                     <span class="n">dense_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="n">s5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SparseTensor(indices=tf.Tensor(
[[0 2]
 [0 1]], shape=(2, 2), dtype=int64), values=tf.Tensor([1. 2.], shape=(2,), dtype=float32), dense_shape=tf.Tensor([3 4], shape=(2,), dtype=int64))
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">s5</span><span class="p">)</span>
<span class="k">except</span> <span class="n">tf</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">InvalidArgumentError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>indices[1] = [0,1] is out of order. Many sparse ops require sorted indices.
    Use `tf.sparse.reorder` to create a correctly ordered copy.

 [Op:SparseToDense]
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-09 13:28:40.017871: W tensorflow/core/framework/op_kernel.cc:1692] OP_REQUIRES failed at sparse_to_dense_op.cc:162 : Invalid argument: indices[1] = [0,1] is out of order. Many sparse ops require sorted indices.
    Use `tf.sparse.reorder` to create a correctly ordered copy.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">s6</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">s5</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">s6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 4), dtype=float32, numpy=
array([[0., 2., 1., 0.],
       [0., 0., 0., 0.],
       [0., 0., 0., 0.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="sets">
<h3>Sets<a class="headerlink" href="#sets" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">set1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> <span class="p">[</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">set2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">],</span> <span class="p">[</span><span class="mi">9</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
<span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sets</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 6), dtype=int32, numpy=
array([[ 2,  3,  4,  5,  6,  7],
       [ 0,  7,  9, 10,  0,  0]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sets</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 3), dtype=int32, numpy=
array([[2, 3, 7],
       [7, 0, 0]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">sparse</span><span class="o">.</span><span class="n">to_dense</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sets</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">set1</span><span class="p">,</span> <span class="n">set2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2, 2), dtype=int32, numpy=
array([[5, 0],
       [0, 9]], dtype=int32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="variables">
<h3>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2557736250.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">v</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1535814499.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">v</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1676375722.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3405521995.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">v</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">([</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">]</span>
<span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1341535160.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">2</span>     <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">,</span> <span class="mf">9.</span><span class="p">]</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">except</span> <span class="ne">TypeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">v</span><span class="o">.</span><span class="n">scatter_nd_update</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
                    <span class="n">updates</span><span class="o">=</span><span class="p">[</span><span class="mf">100.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4168335847.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">v</span><span class="o">.</span><span class="n">scatter_nd_update</span><span class="p">(</span><span class="n">indices</span><span class="o">=</span><span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]],</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                     <span class="n">updates</span><span class="o">=</span><span class="p">[</span><span class="mf">100.</span><span class="p">,</span> <span class="mf">200.</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sparse_delta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">IndexedSlices</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]],</span>
                                <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">v</span><span class="o">.</span><span class="n">scatter_update</span><span class="p">(</span><span class="n">sparse_delta</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2084202032.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">sparse_delta</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">IndexedSlices</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="p">[[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">,</span> <span class="mf">3.</span><span class="p">],</span> <span class="p">[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]],</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>                                 <span class="n">indices</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">v</span><span class="o">.</span><span class="n">scatter_update</span><span class="p">(</span><span class="n">sparse_delta</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;v&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="tensor-arrays">
<h3>Tensor Arrays<a class="headerlink" href="#tensor-arrays" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">array</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorArray</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]))</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">]))</span>
<span class="n">array</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">7.</span><span class="p">]))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([ 3., 10.], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">array</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3, 2), dtype=float32, numpy=
array([[1., 2.],
       [0., 0.],
       [5., 7.]], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">stack</span><span class="p">(),</span> <span class="n">axes</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([2., 3.], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">variance</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(2,), dtype=float32, numpy=array([4.6666665, 8.666667 ], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-loss-function">
<h2>Custom loss function<a class="headerlink" href="#custom-loss-function" title="Permalink to this headline">¶</a></h2>
<p>Let’s start by loading and preparing the California housing dataset. We first load it, then split it into a training set, a validation set and a test set, and finally we scale it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.datasets</span> <span class="kn">import</span> <span class="n">fetch_california_housing</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">housing</span> <span class="o">=</span> <span class="n">fetch_california_housing</span><span class="p">()</span>
<span class="n">X_train_full</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">housing</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">housing</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">,</span>
                                                      <span class="n">y_train_full</span><span class="p">,</span>
                                                      <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span>
<span class="n">X_valid_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
<span class="n">X_test_scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">huber_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span>
    <span class="n">is_small_error</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span>
    <span class="n">squared_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">linear_loss</span>  <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.5</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_small_error</span><span class="p">,</span> <span class="n">squared_loss</span><span class="p">,</span> <span class="n">linear_loss</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">_</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">huber_fn</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">),</span> <span class="s2">&quot;b-&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;huber($z$)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">z</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;b:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s2">&quot;$\frac</span><span class="si">{1}{2}</span><span class="s2">z^2$&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">huber_fn</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">)],</span> <span class="s2">&quot;r--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">huber_fn</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)],</span> <span class="s2">&quot;r--&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">&quot;$z$&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Huber loss&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="s1">&#39;medium&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/103-custom-models_80_0.png" src="../_images/103-custom-models_80_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">input_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">681900977.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">input_shape</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">huber_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2858943865.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">huber_fn</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="saving-loading-models-with-custom-objects">
<h2>Saving/Loading Models with Custom Objects<a class="headerlink" href="#saving-loading-models-with-custom-objects" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">huber_fn</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1992351258.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">huber_fn</span><span class="p">})</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_huber</span><span class="p">(</span><span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">huber_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span>
        <span class="n">is_small_error</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>
        <span class="n">squared_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">linear_loss</span> <span class="o">=</span> <span class="n">threshold</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">-</span> <span class="n">threshold</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_small_error</span><span class="p">,</span> <span class="n">squared_loss</span><span class="p">,</span> <span class="n">linear_loss</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">huber_fn</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4055699429.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2462035004.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss_threshold_2.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss_threshold_2.h5&quot;</span><span class="p">,</span>
                                <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4253141310.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss_threshold_2.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss_threshold_2.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                                 <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)})</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HuberLoss</span><span class="p">(</span><span class="n">losses</span><span class="o">.</span><span class="n">Loss</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">y_true</span> <span class="o">-</span> <span class="n">y_pred</span>
        <span class="n">is_small_error</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="n">squared_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="n">linear_loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">*</span> <span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">is_small_error</span><span class="p">,</span> <span class="n">squared_loss</span><span class="p">,</span> <span class="n">linear_loss</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">base_config</span><span class="p">,</span> <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1391751176.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                  <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                  <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">HuberLoss</span><span class="p">(</span><span class="mf">2.</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1956211390.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">HuberLoss</span><span class="p">(</span><span class="mf">2.</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss_class.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss_class.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;HuberLoss&quot;</span><span class="p">:</span> <span class="n">HuberLoss</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3092523748.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_loss_class.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_loss_class.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;HuberLoss&quot;</span><span class="p">:</span> <span class="n">HuberLoss</span><span class="p">})</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">threshold</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1332327584.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">loss</span><span class="o">.</span><span class="n">threshold</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="other-custom-functions">
<h2>Other Custom Functions<a class="headerlink" href="#other-custom-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_softplus</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>  <span class="c1"># return value is just tf.nn.softplus(z)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">my_glorot_initializer</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">):</span>
    <span class="n">stddev</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">/</span> <span class="p">(</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">stddev</span><span class="o">=</span><span class="n">stddev</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">my_l1_regularizer</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">*</span> <span class="n">weights</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">my_positive_weights</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>  <span class="c1"># return value is just tf.nn.relu(weights)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">weights</span> <span class="o">&lt;</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">weights</span><span class="p">),</span> <span class="n">weights</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">activation</span><span class="o">=</span><span class="n">my_softplus</span><span class="p">,</span>
                     <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">my_glorot_initializer</span><span class="p">,</span>
                     <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">my_l1_regularizer</span><span class="p">,</span>
                     <span class="n">kernel_constraint</span><span class="o">=</span><span class="n">my_positive_weights</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="n">my_softplus</span><span class="p">,</span>
                 <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">my_l1_regularizer</span><span class="p">,</span>
                 <span class="n">kernel_constraint</span><span class="o">=</span><span class="n">my_positive_weights</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">my_glorot_initializer</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1595023419.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1308691927.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
                              <span class="s2">&quot;my_l1_regularizer&quot;</span><span class="p">:</span> <span class="n">my_l1_regularizer</span><span class="p">,</span>
                              <span class="s2">&quot;my_positive_weights&quot;</span><span class="p">:</span> <span class="n">my_positive_weights</span><span class="p">,</span>
                              <span class="s2">&quot;my_glorot_initializer&quot;</span><span class="p">:</span> <span class="n">my_glorot_initializer</span><span class="p">,</span>
                              <span class="s2">&quot;my_softplus&quot;</span><span class="p">:</span> <span class="n">my_softplus</span><span class="p">,</span>
                          <span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3720850194.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                               <span class="s2">&quot;my_l1_regularizer&quot;</span><span class="p">:</span> <span class="n">my_l1_regularizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                               <span class="s2">&quot;my_positive_weights&quot;</span><span class="p">:</span> <span class="n">my_positive_weights</span><span class="p">,</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyL1Regularizer</span><span class="p">(</span><span class="n">regularizers</span><span class="o">.</span><span class="n">Regularizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">factor</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">=</span> <span class="n">factor</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">factor</span> <span class="o">*</span> <span class="n">weights</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;factor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">factor</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="n">my_softplus</span><span class="p">,</span>
                 <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">MyL1Regularizer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">),</span>
                 <span class="n">kernel_constraint</span><span class="o">=</span><span class="n">my_positive_weights</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="n">my_glorot_initializer</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3462535765.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1308691927.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;mae&quot;</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3680708404.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
                              <span class="s2">&quot;MyL1Regularizer&quot;</span><span class="p">:</span> <span class="n">MyL1Regularizer</span><span class="p">,</span>
                              <span class="s2">&quot;my_positive_weights&quot;</span><span class="p">:</span> <span class="n">my_positive_weights</span><span class="p">,</span>
                              <span class="s2">&quot;my_glorot_initializer&quot;</span><span class="p">:</span> <span class="n">my_glorot_initializer</span><span class="p">,</span>
                              <span class="s2">&quot;my_softplus&quot;</span><span class="p">:</span> <span class="n">my_softplus</span><span class="p">,</span>
                          <span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">317533974.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_many_custom_parts.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                               <span class="s2">&quot;MyL1Regularizer&quot;</span><span class="p">:</span> <span class="n">MyL1Regularizer</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                               <span class="s2">&quot;my_positive_weights&quot;</span><span class="p">:</span> <span class="n">my_positive_weights</span><span class="p">,</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-metrics">
<h2>Custom Metrics<a class="headerlink" href="#custom-metrics" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1062154147.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1548172514.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">268895691.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong>: if you use the same function as the loss and a metric, you may be surprised to see different results. This is generally just due to floating point precision errors: even though the mathematical equations are equivalent, the operations are not run in the same order, which can lead to small differences. Moreover, when using sample weights, there’s more than just precision errors:</p>
<ul class="simple">
<li><p>the loss since the start of the epoch is the mean of all batch losses seen so far. Each batch loss is the sum of the weighted instance losses divided by the <em>batch size</em> (not the sum of weights, so the batch loss is <em>not</em> the weighted mean of the losses).</p></li>
<li><p>the metric since the start of the epoch is equal to the sum of weighted instance losses divided by sum of all weights seen so far. In other words, it is the weighted mean of all the instance losses. Not the same thing.</p></li>
</ul>
<p>If you do the math, you will find that loss = metric * mean of sample weights (plus some floating point precision error).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2689227703.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1425910630.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">535717251.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;huber_fn&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;history&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="section" id="streaming-metrics">
<h3>Streaming metrics<a class="headerlink" href="#streaming-metrics" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Precision</span><span class="p">()</span>
<span class="n">precision</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4195330993.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">precision</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Precision</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">precision</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, thresholds, top_k, class_id, name, dtype)</span>
<span class="g g-Whitespace">   </span><span class="mi">1330</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_thresholds_distributed_evenly</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1331</span>         <span class="n">metrics_utils</span><span class="o">.</span><span class="n">is_evenly_distributed_thresholds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">))</span>
<span class="ne">-&gt; </span><span class="mi">1332</span>     <span class="bp">self</span><span class="o">.</span><span class="n">true_positives</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1333</span>         <span class="s1">&#39;true_positives&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1334</span>         <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">thresholds</span><span class="p">),),</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/IPython/core/formatters.py</span> in <span class="ni">_float_precision_changed</span><span class="nt">(self, change)</span>
<span class="g g-Whitespace">    </span><span class="mi">650</span>             <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">651</span>                 <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">652</span>                 <span class="k">assert</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span>

<span class="ne">ValueError</span>: invalid literal for int() with base 10: &#39;([0, 1, 0, 0, 1, 0, 1, 1], [1, 0, 1, 1, 0, 0, 0, 0])&#39;

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1162791899.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">run_line_magic</span><span class="p">(</span><span class="s1">&#39;precision&#39;</span><span class="p">,</span> <span class="s1">&#39;([0, 1, 0, 0, 1, 0, 1, 1], [1, 0, 1, 1, 0, 0, 0, 0])&#39;</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/IPython/core/interactiveshell.py</span> in <span class="ni">run_line_magic</span><span class="nt">(self, magic_name, line, _stack_depth)</span>
<span class="g g-Whitespace">   </span><span class="mi">2349</span>                 <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;local_ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_local_scope</span><span class="p">(</span><span class="n">stack_depth</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2350</span>             <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">builtin_trap</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">2351</span>                 <span class="n">result</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2352</span>             <span class="k">return</span> <span class="n">result</span>
<span class="g g-Whitespace">   </span><span class="mi">2353</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/decorator.py</span> in <span class="ni">fun</span><span class="nt">(*args, **kw)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span>             <span class="k">if</span> <span class="ow">not</span> <span class="n">kwsyntax</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>                 <span class="n">args</span><span class="p">,</span> <span class="n">kw</span> <span class="o">=</span> <span class="n">fix</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kw</span><span class="p">,</span> <span class="n">sig</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">232</span>             <span class="k">return</span> <span class="n">caller</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">extras</span> <span class="o">+</span> <span class="n">args</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>     <span class="n">fun</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__name__</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span>     <span class="n">fun</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/IPython/core/magic.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(f, *a, **k)</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span>     <span class="c1"># but it&#39;s overkill for just that one bit of state.</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span>     <span class="k">def</span> <span class="nf">magic_deco</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">187</span>         <span class="n">call</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="o">**</span><span class="n">k</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span> 
<span class="g g-Whitespace">    </span><span class="mi">189</span>         <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/IPython/core/magics/basic.py</span> in <span class="ni">precision</span><span class="nt">(self, s)</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span>         <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span><span class="sd">         ptformatter = self.shell.display_formatter.formatters[&#39;text/plain&#39;]</span>
<span class="ne">--&gt; </span><span class="mi">558</span><span class="sd">         ptformatter.float_precision = s</span>
<span class="g g-Whitespace">    </span><span class="mi">559</span><span class="sd">         return ptformatter.float_format</span>
<span class="g g-Whitespace">    </span><span class="mi">560</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/traitlets/traitlets.py</span> in <span class="ni">__set__</span><span class="nt">(self, obj, value)</span>
<span class="g g-Whitespace">    </span><span class="mi">604</span><span class="sd">             raise TraitError(&#39;The &quot;%s&quot; trait is read-only.&#39; % self.name)</span>
<span class="g g-Whitespace">    </span><span class="mi">605</span><span class="sd">         else:</span>
<span class="ne">--&gt; </span><span class="mi">606</span><span class="sd">             self.set(obj, value)</span>
<span class="g g-Whitespace">    </span><span class="mi">607</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">608</span><span class="sd">     def _validate(self, obj, value):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/traitlets/traitlets.py</span> in <span class="ni">set</span><span class="nt">(self, obj, value)</span>
<span class="g g-Whitespace">    </span><span class="mi">593</span><span class="sd">             # we explicitly compare silent to True just in case the equality</span>
<span class="g g-Whitespace">    </span><span class="mi">594</span><span class="sd">             # comparison above returns something other than True/False</span>
<span class="ne">--&gt; </span><span class="mi">595</span><span class="sd">             obj._notify_trait(self.name, old_value, new_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">596</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">597</span><span class="sd">     def __set__(self, obj, value):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/traitlets/traitlets.py</span> in <span class="ni">_notify_trait</span><span class="nt">(self, name, old_value, new_value)</span>
<span class="g g-Whitespace">   </span><span class="mi">1217</span><span class="sd"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1218</span><span class="sd">     def _notify_trait(self, name, old_value, new_value):</span>
<span class="ne">-&gt; </span><span class="mi">1219</span><span class="sd">         self.notify_change(Bunch(</span>
<span class="g g-Whitespace">   </span><span class="mi">1220</span><span class="sd">             name=name,</span>
<span class="g g-Whitespace">   </span><span class="mi">1221</span><span class="sd">             old=old_value,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/traitlets/traitlets.py</span> in <span class="ni">notify_change</span><span class="nt">(self, change)</span>
<span class="g g-Whitespace">   </span><span class="mi">1227</span><span class="sd">     def notify_change(self, change):</span>
<span class="g g-Whitespace">   </span><span class="mi">1228</span><span class="sd">         &quot;&quot;&quot;</span><span class="n">Notify</span> <span class="n">observers</span> <span class="n">of</span> <span class="n">a</span> <span class="n">change</span> <span class="n">event</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1229</span><span class="s2">         return self._notify_observers(change)</span>
<span class="g g-Whitespace">   </span><span class="mi">1230</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1231</span><span class="s2">     def _notify_observers(self, event):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/traitlets/traitlets.py</span> in <span class="ni">_notify_observers</span><span class="nt">(self, event)</span>
<span class="g g-Whitespace">   </span><span class="mi">1264</span><span class="s2">                 c = getattr(self, c.name)</span>
<span class="g g-Whitespace">   </span><span class="mi">1265</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">1266</span><span class="s2">             c(event)</span>
<span class="g g-Whitespace">   </span><span class="mi">1267</span><span class="s2"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1268</span><span class="s2">     def _add_notifiers(self, handler, name, type):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/IPython/core/formatters.py</span> in <span class="ni">_float_precision_changed</span><span class="nt">(self, change)</span>
<span class="g g-Whitespace">    </span><span class="mi">652</span><span class="s2">                 assert i &gt;= 0</span>
<span class="g g-Whitespace">    </span><span class="mi">653</span><span class="s2">             except ValueError:</span>
<span class="ne">--&gt; </span><span class="mi">654</span><span class="s2">                 raise ValueError(&quot;Precision must be int or format string, not </span><span class="si">%r</span><span class="s2">&quot;%new)</span>
<span class="g g-Whitespace">    </span><span class="mi">655</span><span class="s2">             except AssertionError:</span>
<span class="g g-Whitespace">    </span><span class="mi">656</span><span class="s2">                 raise ValueError(&quot;int precision must be non-negative, not </span><span class="si">%r</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2">)</span>

<span class="ne">ValueError</span>: Precision must be int or format string, not &#39;([0, 1, 0, 0, 1, 0, 1, 1], [1, 0, 1, 1, 0, 0, 0, 0])&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1440848956.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">precision</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;precision&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision</span><span class="o">.</span><span class="n">variables</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1250504293.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">precision</span><span class="o">.</span><span class="n">variables</span>

<span class="ne">NameError</span>: name &#39;precision&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">precision</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3346479094.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">precision</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;precision&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Creating a streaming metric:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HuberMetric</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">Metric</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>  <span class="c1"># handles base args (e.g., dtype)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">huber_fn</span> <span class="o">=</span> <span class="n">create_huber</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">huber_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">metric</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">y_true</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">base_config</span><span class="p">,</span> <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span> <span class="o">=</span> <span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>

<span class="c1"># total = 2 * |10 - 2| - 2²/2 = 14</span>
<span class="c1"># count = 1</span>
<span class="c1"># result = 14 / 1 = 14</span>
<span class="n">m</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">2.</span><span class="p">]]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">10.</span><span class="p">]]))</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2111966438.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">m</span> <span class="o">=</span> <span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># total = 2 * |10 - 2| - 2²/2 = 14</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="c1"># count = 1</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="c1"># result = 14 / 1 = 14</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/1188467431.py</span> in <span class="ni">__init__</span><span class="nt">(self, threshold, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="bp">self</span><span class="o">.</span><span class="n">huber_fn</span> <span class="o">=</span> <span class="n">create_huber</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">6</span>         <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="s2">&quot;total&quot;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>         <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># total = total + (|1 - 0|² / 2) + (2 * |9.25 - 5| - 2² / 2) = 14 + 7 = 21</span>
<span class="c1"># count = count + 2 = 3</span>
<span class="c1"># result = total / count = 21 / 3 = 7</span>
<span class="n">m</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.</span><span class="p">]]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">9.25</span><span class="p">]]))</span>

<span class="n">m</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">139678981.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="c1"># count = count + 2 = 3</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="c1"># result = total / count = 21 / 3 = 7</span>
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">m</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">0.</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.</span><span class="p">]]),</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="mf">9.25</span><span class="p">]]))</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">m</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;m&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">variables</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2897026842.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">m</span><span class="o">.</span><span class="n">variables</span>

<span class="ne">NameError</span>: name &#39;m&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">m</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
<span class="n">m</span><span class="o">.</span><span class="n">variables</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3457455407.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">m</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">m</span><span class="o">.</span><span class="n">variables</span>

<span class="ne">NameError</span>: name &#39;m&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Let’s check that the <code class="docutils literal notranslate"><span class="pre">HuberMetric</span></code> class works well:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1062154147.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2517403725.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1927751795.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_metric.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_metric.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
                              <span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
                              <span class="s2">&quot;HuberMetric&quot;</span><span class="p">:</span> <span class="n">HuberMetric</span>
                          <span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2920632995.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_metric.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_metric.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                               <span class="s2">&quot;huber_fn&quot;</span><span class="p">:</span> <span class="n">create_huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                               <span class="s2">&quot;HuberMetric&quot;</span><span class="p">:</span> <span class="n">HuberMetric</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1927751795.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p><strong>Warning</strong>: In TF 2.2, tf.keras adds an extra first metric in <code class="docutils literal notranslate"><span class="pre">model.metrics</span></code> at position 0 (see <a class="reference external" href="https://github.com/tensorflow/tensorflow/issues/38150">TF issue #38150</a>). This forces us to use <code class="docutils literal notranslate"><span class="pre">model.metrics[-1]</span></code> rather than <code class="docutils literal notranslate"><span class="pre">model.metrics[0]</span></code> to access the <code class="docutils literal notranslate"><span class="pre">HuberMetric</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">threshold</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">738178153.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">threshold</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Looks like it works fine! More simply, we could have created the class like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">HuberMetric</span><span class="p">(</span><span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;HuberMetric&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">huber_fn</span> <span class="o">=</span> <span class="n">create_huber</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">huber_fn</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">HuberMetric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">update_state</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">base_config</span><span class="p">,</span> <span class="s2">&quot;threshold&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>This class handles shapes better, and it also supports sample weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1062154147.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="o">.</span><span class="n">Huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span>
              <span class="n">weighted_metrics</span><span class="o">=</span><span class="p">[</span><span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">9964806.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="o">.</span><span class="n">Huber</span><span class="p">(</span><span class="mf">2.0</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>               <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>               <span class="n">weighted_metrics</span><span class="o">=</span><span class="p">[</span><span class="n">HuberMetric</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
                    <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2022500162.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">sample_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                     <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>                     <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                     <span class="n">sample_weight</span><span class="o">=</span><span class="n">sample_weight</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;HuberMetric&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3014534817.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">history</span><span class="o">.</span><span class="n">history</span><span class="p">[</span><span class="s2">&quot;HuberMetric&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_weight</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;history&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_metric_v2.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_metric_v2.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;HuberMetric&quot;</span><span class="p">:</span> <span class="n">HuberMetric</span><span class="p">})</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2321386638.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_metric_v2.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_metric_v2.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;HuberMetric&quot;</span><span class="p">:</span> <span class="n">HuberMetric</span><span class="p">})</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">threshold</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">738178153.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">threshold</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-layers">
<h2>Custom Layers<a class="headerlink" href="#custom-layers" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exponential_layer</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Lambda</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">exponential_layer</span><span class="p">([</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(3,), dtype=float32, numpy=array([0.36787945, 1.        , 2.7182817 ], dtype=float32)&gt;
</pre></div>
</div>
</div>
</div>
<p>Adding an exponential layer at the output of a regression model can be useful if the values to predict are positive and with very different scales (e.g., 0.001, 10., 10000):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">exponential_layer</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;sgd&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2867970777.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">exponential_layer</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyDense</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">activations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;kernel&quot;</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">batch_input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">],</span>
            <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;glorot_normal&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bias</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;bias&quot;</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">],</span>
                                    <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">batch_input_shape</span><span class="p">)</span>  <span class="c1"># must be at the end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bias</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">compute_output_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">TensorShape</span><span class="p">(</span><span class="n">batch_input_shape</span><span class="o">.</span><span class="n">as_list</span><span class="p">()[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">base_config</span><span class="p">,</span> <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span>
            <span class="s2">&quot;activation&quot;</span><span class="p">:</span> <span class="n">activations</span><span class="o">.</span><span class="n">serialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">)</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
    <span class="p">[</span><span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
     <span class="n">MyDense</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1015907658.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="p">[</span><span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="n">input_shape</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>      <span class="n">MyDense</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_layer.h5&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_layer.h5&quot;</span><span class="p">,</span>
                          <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;MyDense&quot;</span><span class="p">:</span> <span class="n">MyDense</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">672591543.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_model_with_a_custom_layer.h5&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_model_with_a_custom_layer.h5&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>                           <span class="n">custom_objects</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;MyDense&quot;</span><span class="p">:</span> <span class="n">MyDense</span><span class="p">})</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">198</span>         <span class="k">if</span> <span class="p">(</span><span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
<span class="g g-Whitespace">    </span><span class="mi">199</span>             <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">is_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">))):</span>
<span class="ne">--&gt; </span><span class="mi">200</span>           <span class="k">return</span> <span class="n">hdf5_format</span><span class="o">.</span><span class="n">load_model_from_hdf5</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">custom_objects</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">201</span>                                                   <span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/hdf5_format.py</span> in <span class="ni">load_model_from_hdf5</span><span class="nt">(filepath, custom_objects, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">178</span>       <span class="n">model_config</span> <span class="o">=</span> <span class="n">model_config</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>     <span class="n">model_config</span> <span class="o">=</span> <span class="n">json_utils</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">model_config</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">180</span>     <span class="n">model</span> <span class="o">=</span> <span class="n">model_config_lib</span><span class="o">.</span><span class="n">model_from_config</span><span class="p">(</span><span class="n">model_config</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">181</span>                                                <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">182</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/model_config.py</span> in <span class="ni">model_from_config</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span>                     <span class="s1">&#39;`Sequential.from_config(config)`?&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">51</span>   <span class="kn">from</span> <span class="nn">keras.layers</span> <span class="kn">import</span> <span class="n">deserialize</span>  <span class="c1"># pylint: disable=g-import-not-at-top</span>
<span class="ne">---&gt; </span><span class="mi">52</span>   <span class="k">return</span> <span class="n">deserialize</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">custom_objects</span><span class="o">=</span><span class="n">custom_objects</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">53</span> 
<span class="g g-Whitespace">     </span><span class="mi">54</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/serialization.py</span> in <span class="ni">deserialize</span><span class="nt">(config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>   <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span><span class="sd">   populate_deserializable_objects()</span>
<span class="ne">--&gt; </span><span class="mi">208</span><span class="sd">   return generic_utils.deserialize_keras_object(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span><span class="sd">       config,</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span><span class="sd">       module_objects=LOCAL.ALL_OBJECTS,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/utils/generic_utils.py</span> in <span class="ni">deserialize_keras_object</span><span class="nt">(identifier, module_objects, custom_objects, printable_module_name)</span>
<span class="g g-Whitespace">    </span><span class="mi">672</span><span class="sd"> </span>
<span class="g g-Whitespace">    </span><span class="mi">673</span><span class="sd">       if &#39;custom_objects&#39; in arg_spec.args:</span>
<span class="ne">--&gt; </span><span class="mi">674</span><span class="sd">         deserialized_obj = cls.from_config(</span>
<span class="g g-Whitespace">    </span><span class="mi">675</span><span class="sd">             cls_config,</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span><span class="sd">             custom_objects=dict(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">from_config</span><span class="nt">(cls, config, custom_objects)</span>
<span class="g g-Whitespace">    </span><span class="mi">428</span><span class="sd">       build_input_shape = None</span>
<span class="g g-Whitespace">    </span><span class="mi">429</span><span class="sd">       layer_configs = config</span>
<span class="ne">--&gt; </span><span class="mi">430</span><span class="sd">     model = cls(name=name)</span>
<span class="g g-Whitespace">    </span><span class="mi">431</span><span class="sd">     for layer_config in layer_configs:</span>
<span class="g g-Whitespace">    </span><span class="mi">432</span><span class="sd">       layer = layer_module.deserialize(layer_config,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span>     <span class="c1"># Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span>     <span class="nb">super</span><span class="p">(</span><span class="n">functional</span><span class="o">.</span><span class="n">Functional</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>  <span class="c1"># pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">autocast</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span>     <span class="n">base_layer</span><span class="o">.</span><span class="n">keras_api_gauge</span><span class="o">.</span><span class="n">get_cell</span><span class="p">(</span><span class="s1">&#39;Sequential&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyMultiLayer</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">X1</span><span class="p">,</span> <span class="n">X2</span> <span class="o">=</span> <span class="n">X</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;X1.shape: &quot;</span><span class="p">,</span> <span class="n">X1</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot; X2.shape: &quot;</span><span class="p">,</span>
              <span class="n">X2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>  <span class="c1"># Debugging of custom layer</span>
        <span class="k">return</span> <span class="n">X1</span> <span class="o">+</span> <span class="n">X2</span><span class="p">,</span> <span class="n">X1</span> <span class="o">*</span> <span class="n">X2</span>

    <span class="k">def</span> <span class="nf">compute_output_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="n">batch_input_shape1</span><span class="p">,</span> <span class="n">batch_input_shape2</span> <span class="o">=</span> <span class="n">batch_input_shape</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">batch_input_shape1</span><span class="p">,</span> <span class="n">batch_input_shape2</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Our custom layer can be called using the functional API like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inputs1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">inputs2</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">outputs1</span><span class="p">,</span> <span class="n">outputs2</span> <span class="o">=</span> <span class="n">MyMultiLayer</span><span class="p">()((</span><span class="n">inputs1</span><span class="p">,</span> <span class="n">inputs2</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X1.shape:  (None, 2)  X2.shape:  (None, 2)
</pre></div>
</div>
</div>
</div>
<p>Note that the <code class="docutils literal notranslate"><span class="pre">call()</span></code> method receives symbolic inputs, whose shape is only partially specified (at this stage, we don’t know the batch size, which is why the first dimension is <code class="docutils literal notranslate"><span class="pre">None</span></code>):</p>
<p>We can also pass actual data to the custom layer. To test this, let’s split each dataset’s inputs into two parts, with four features each:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">split_data</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">columns_count</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">half</span> <span class="o">=</span> <span class="n">columns_count</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">[:,</span> <span class="p">:</span><span class="n">half</span><span class="p">],</span> <span class="n">data</span><span class="p">[:,</span> <span class="n">half</span><span class="p">:]</span>


<span class="n">X_train_scaled_A</span><span class="p">,</span> <span class="n">X_train_scaled_B</span> <span class="o">=</span> <span class="n">split_data</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">)</span>
<span class="n">X_valid_scaled_A</span><span class="p">,</span> <span class="n">X_valid_scaled_B</span> <span class="o">=</span> <span class="n">split_data</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">)</span>
<span class="n">X_test_scaled_A</span><span class="p">,</span> <span class="n">X_test_scaled_B</span> <span class="o">=</span> <span class="n">split_data</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># Printing the splitted data shapes</span>
<span class="n">X_train_scaled_A</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">X_train_scaled_B</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>((11610, 4), (11610, 4))
</pre></div>
</div>
</div>
</div>
<p>Now notice that the shapes are fully specified:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">outputs1</span><span class="p">,</span> <span class="n">outputs2</span> <span class="o">=</span> <span class="n">MyMultiLayer</span><span class="p">()((</span><span class="n">X_train_scaled_A</span><span class="p">,</span> <span class="n">X_train_scaled_B</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X1.shape:  (11610, 4)  X2.shape:  (11610, 4)
</pre></div>
</div>
</div>
</div>
<p>Let’s build a more complete model using the functional API (this is just a toy example, don’t expect awesome performance):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">input_A</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">X_train_scaled_A</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">input_B</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">X_train_scaled_B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">hidden_A</span><span class="p">,</span> <span class="n">hidden_B</span> <span class="o">=</span> <span class="n">MyMultiLayer</span><span class="p">()((</span><span class="n">input_A</span><span class="p">,</span> <span class="n">input_B</span><span class="p">))</span>
<span class="n">hidden_A</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">)(</span><span class="n">hidden_A</span><span class="p">)</span>
<span class="n">hidden_B</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">)(</span><span class="n">hidden_B</span><span class="p">)</span>
<span class="n">concat</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()((</span><span class="n">hidden_A</span><span class="p">,</span> <span class="n">hidden_B</span><span class="p">))</span>
<span class="n">output</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)(</span><span class="n">concat</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="p">[</span><span class="n">input_A</span><span class="p">,</span> <span class="n">input_B</span><span class="p">],</span> <span class="n">outputs</span><span class="o">=</span><span class="p">[</span><span class="n">output</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>X1.shape:  (None, 4)  X2.shape:  (None, 4)
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3469793840.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">input_B</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">X_train_scaled_B</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">hidden_A</span><span class="p">,</span> <span class="n">hidden_B</span> <span class="o">=</span> <span class="n">MyMultiLayer</span><span class="p">()((</span><span class="n">input_A</span><span class="p">,</span> <span class="n">input_B</span><span class="p">))</span>
<span class="ne">----&gt; </span><span class="mi">8</span> <span class="n">hidden_A</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">)(</span><span class="n">hidden_A</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">hidden_B</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;selu&#39;</span><span class="p">)(</span><span class="n">hidden_B</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="n">concat</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Concatenate</span><span class="p">()((</span><span class="n">hidden_A</span><span class="p">,</span> <span class="n">hidden_B</span><span class="p">))</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">974</span>     <span class="c1"># &gt;&gt; model = tf.keras.Model(inputs, outputs)</span>
<span class="g g-Whitespace">    </span><span class="mi">975</span>     <span class="k">if</span> <span class="n">_in_functional_construction_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">input_list</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">976</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_functional_construction_call</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">977</span>                                                 <span class="n">input_list</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">978</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">_functional_construction_call</span><span class="nt">(self, inputs, args, kwargs, input_list)</span>
<span class="g g-Whitespace">   </span><span class="mi">1112</span>         <span class="n">layer</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span> <span class="n">build_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="n">training_value</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1113</span>       <span class="c1"># Check input assumptions set after layer building, e.g. input shape.</span>
<span class="ne">-&gt; </span><span class="mi">1114</span>       <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keras_tensor_symbolic_call</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1115</span>           <span class="n">inputs</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1116</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">_keras_tensor_symbolic_call</span><span class="nt">(self, inputs, input_masks, args, kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">846</span>       <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">nest</span><span class="o">.</span><span class="n">map_structure</span><span class="p">(</span><span class="n">keras_tensor</span><span class="o">.</span><span class="n">KerasTensor</span><span class="p">,</span> <span class="n">output_signature</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">847</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">848</span>       <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_output_signature</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">849</span> 
<span class="g g-Whitespace">    </span><span class="mi">850</span>   <span class="k">def</span> <span class="nf">_infer_output_signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">input_masks</span><span class="p">):</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">_infer_output_signature</span><span class="nt">(self, inputs, args, kwargs, input_masks)</span>
<span class="g g-Whitespace">    </span><span class="mi">884</span>           <span class="c1"># overridden).</span>
<span class="g g-Whitespace">    </span><span class="mi">885</span>           <span class="c1"># TODO(kaftan): do we maybe_build here, or have we already done it?</span>
<span class="ne">--&gt; </span><span class="mi">886</span>           <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">887</span>           <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_cast_inputs</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">888</span>           <span class="n">outputs</span> <span class="o">=</span> <span class="n">call_fn</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">_maybe_build</span><span class="nt">(self, inputs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2657</span>         <span class="c1"># operations.</span>
<span class="g g-Whitespace">   </span><span class="mi">2658</span>         <span class="k">with</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">maybe_init_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">2659</span>           <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shapes</span><span class="p">)</span>  <span class="c1"># pylint:disable=not-callable</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>       <span class="c1"># We must set also ensure that the layer is marked as built, and the build</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span>       <span class="c1"># shape is stored since user defined build functions may not be calling</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/core.py</span> in <span class="ni">build</span><span class="nt">(self, input_shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1176</span>                        <span class="s1">&#39;should be defined. Found `None`.&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1177</span>     <span class="bp">self</span><span class="o">.</span><span class="n">input_spec</span> <span class="o">=</span> <span class="n">InputSpec</span><span class="p">(</span><span class="n">min_ndim</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span> <span class="n">last_dim</span><span class="p">})</span>
<span class="ne">-&gt; </span><span class="mi">1178</span>     <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1179</span>         <span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1180</span>         <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="n">last_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">],</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;nadam&#39;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">((</span><span class="n">X_train_scaled_A</span><span class="p">,</span> <span class="n">X_train_scaled_B</span><span class="p">),</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">((</span><span class="n">X_valid_scaled_A</span><span class="p">,</span> <span class="n">X_valid_scaled_B</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">545253094.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s1">&#39;mse&#39;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s1">&#39;nadam&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">((</span><span class="n">X_train_scaled_A</span><span class="p">,</span> <span class="n">X_train_scaled_B</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">((</span><span class="n">X_valid_scaled_A</span><span class="p">,</span> <span class="n">X_valid_scaled_B</span><span class="p">),</span> <span class="n">y_valid</span><span class="p">))</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Now let’s create a layer with a different behavior during training and testing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">AddGaussianNoise</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stddev</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stddev</span> <span class="o">=</span> <span class="n">stddev</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">stddev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stddev</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">X</span> <span class="o">+</span> <span class="n">noise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>

    <span class="k">def</span> <span class="nf">compute_output_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">batch_input_shape</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s a simple model that uses this custom layer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">AddGaussianNoise</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">704690957.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">AddGaussianNoise</span><span class="p">(</span><span class="n">stddev</span><span class="o">=</span><span class="mf">1.0</span><span class="p">),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">),</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>Custom Models<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_new_scaled</span> <span class="o">=</span> <span class="n">X_test_scaled</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResidualBlock</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">n_neurons</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">n_neurons</span><span class="p">,</span>
                         <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span>
                         <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_layers</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">:</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">inputs</span> <span class="o">+</span> <span class="n">Z</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResidualRegressor</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                                    <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span>
                                    <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block1</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">block2</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">):</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">3</span><span class="p">):</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block1</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block2</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ResidualRegressor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2276714086.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">ResidualRegressor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/304384386.py</span> in <span class="ni">__init__</span><span class="nt">(self, output_dim, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">class</span> <span class="nc">ResidualRegressor</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">3</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                                     <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># model.save(&quot;data/103/my_custom_model.ckpt&quot;)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_custom_model.ckpt&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:SavedModel saved prior to TF 2.5 detected when loading Keras model. Please ensure that you are saving the model with model.save() or tf.keras.models.save_model(), *NOT* tf.saved_model.save(). To confirm, there should be a file named &quot;keras_metadata.pb&quot; in the SavedModel directory.
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">901358346.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1"># model.save(&quot;data/103/my_custom_model.ckpt&quot;)</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">load_model</span><span class="p">(</span><span class="s2">&quot;data/103/my_custom_model.ckpt&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/save.py</span> in <span class="ni">load_model</span><span class="nt">(filepath, custom_objects, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>         <span class="n">filepath</span> <span class="o">=</span> <span class="n">path_to_string</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">205</span>           <span class="k">return</span> <span class="n">saved_model_load</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="nb">compile</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span> 
<span class="g g-Whitespace">    </span><span class="mi">207</span>   <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/saved_model/load.py</span> in <span class="ni">load</span><span class="nt">(path, compile, options)</span>
<span class="g g-Whitespace">    </span><span class="mi">132</span>   <span class="c1"># Recreate layers and metrics using the info stored in the metadata.</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span>   <span class="n">keras_loader</span> <span class="o">=</span> <span class="n">KerasObjectLoader</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">object_graph_def</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">134</span>   <span class="n">keras_loader</span><span class="o">.</span><span class="n">load_layers</span><span class="p">(</span><span class="nb">compile</span><span class="o">=</span><span class="nb">compile</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">135</span> 
<span class="g g-Whitespace">    </span><span class="mi">136</span>   <span class="c1"># Generate a dictionary of all loaded nodes.</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/saved_model/load.py</span> in <span class="ni">load_layers</span><span class="nt">(self, compile)</span>
<span class="g g-Whitespace">    </span><span class="mi">392</span>         <span class="k">continue</span>
<span class="g g-Whitespace">    </span><span class="mi">393</span> 
<span class="ne">--&gt; </span><span class="mi">394</span>       <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">node_metadata</span><span class="o">.</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_layer</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">395</span>           <span class="n">node_metadata</span><span class="o">.</span><span class="n">node_id</span><span class="p">,</span> <span class="n">node_metadata</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">396</span>           <span class="n">node_metadata</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/saved_model/load.py</span> in <span class="ni">_load_layer</span><span class="nt">(self, node_id, identifier, metadata)</span>
<span class="g g-Whitespace">    </span><span class="mi">436</span>     <span class="n">obj</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_revive_from_config</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">node_id</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">437</span>     <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">438</span>       <span class="n">obj</span><span class="p">,</span> <span class="n">setter</span> <span class="o">=</span> <span class="n">revive_custom_object</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">439</span> 
<span class="g g-Whitespace">    </span><span class="mi">440</span>     <span class="c1"># Add an attribute that stores the extra functions/objects saved in the</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/saved_model/load.py</span> in <span class="ni">revive_custom_object</span><span class="nt">(identifier, metadata)</span>
<span class="g g-Whitespace">    </span><span class="mi">985</span>     <span class="n">revived_cls</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">986</span>         <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">as_str</span><span class="p">(</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;class_name&#39;</span><span class="p">]),</span> <span class="n">parent_classes</span><span class="p">,</span> <span class="p">{})</span>
<span class="ne">--&gt; </span><span class="mi">987</span>     <span class="k">return</span> <span class="n">revived_cls</span><span class="o">.</span><span class="n">_init_from_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">988</span>   <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">989</span>     <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to restore custom object of type </span><span class="si">{}</span><span class="s1"> currently. &#39;</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/saving/saved_model/load.py</span> in <span class="ni">_init_from_metadata</span><span class="nt">(cls, metadata)</span>
<span class="g g-Whitespace">   </span><span class="mi">1182</span>   <span class="k">def</span> <span class="nf">_init_from_metadata</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1183</span>     <span class="sd">&quot;&quot;&quot;Create revived network from metadata stored in the SavedModel proto.&quot;&quot;&quot;</span>
<span class="ne">-&gt; </span><span class="mi">1184</span>     <span class="n">revived_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
<span class="g g-Whitespace">   </span><span class="mi">1185</span> 
<span class="g g-Whitespace">   </span><span class="mi">1186</span>     <span class="c1"># Store attributes revived from SerializedAttributes in a un-tracked</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<p>We could have defined the model using the sequential API instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">block1</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">),</span> <span class="n">block1</span><span class="p">,</span>
    <span class="n">block1</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span>
    <span class="n">ResidualBlock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="p">])</span>

<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">score</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_new_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1432547346.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">block1</span> <span class="o">=</span> <span class="n">ResidualBlock</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span> <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">),</span> <span class="n">block1</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">block1</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span> <span class="n">block1</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="losses-and-metrics-based-on-model-internals">
<h2>Losses and Metrics Based on Model Internals<a class="headerlink" href="#losses-and-metrics-based-on-model-internals" title="Permalink to this headline">¶</a></h2>
<p><strong>Note</strong>: due to an issue introduced in TF 2.2 (<a class="reference external" href="https://github.com/tensorflow/tensorflow/issues/46858">#46858</a>), it is currently not possible to use <code class="docutils literal notranslate"><span class="pre">add_loss()</span></code> along with the <code class="docutils literal notranslate"><span class="pre">build()</span></code> method. So the following code differs from the book: I create the <code class="docutils literal notranslate"><span class="pre">reconstruct</span></code> layer in the constructor instead of the <code class="docutils literal notranslate"><span class="pre">build()</span></code> method. Unfortunately, this means that the number of units in this layer must be hard-coded (alternatively, it could be passed as an argument to the constructor).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ReconstructingRegressor</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                         <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;selu&quot;</span><span class="p">,</span>
                         <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;lecun_normal&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="n">output_dim</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconstruct</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>  <span class="c1"># workaround for TF issue #46858</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reconstruction_mean</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;reconstruction_error&quot;</span><span class="p">)</span>

    <span class="c1">#Commented out due to TF issue #46858, see the note above</span>
    <span class="c1">#def build(self, batch_input_shape):</span>
    <span class="c1">#    n_inputs = batch_input_shape[-1]</span>
    <span class="c1">#    self.reconstruct = layers.Dense(n_inputs)</span>
    <span class="c1">#    super().build(batch_input_shape)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">,</span> <span class="n">training</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">Z</span> <span class="o">=</span> <span class="n">inputs</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span><span class="p">:</span>
            <span class="n">Z</span> <span class="o">=</span> <span class="n">layer</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">reconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstruct</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
        <span class="n">recon_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">reconstruction</span> <span class="o">-</span> <span class="n">inputs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_loss</span><span class="p">(</span><span class="mf">0.05</span> <span class="o">*</span> <span class="n">recon_loss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reconstruction_mean</span><span class="p">(</span><span class="n">recon_loss</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_metric</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">(</span><span class="n">Z</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ReconstructingRegressor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4185161651.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">ReconstructingRegressor</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">history</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/2988422247.py</span> in <span class="ni">__init__</span><span class="nt">(self, output_dim, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">class</span> <span class="nc">ReconstructingRegressor</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">output_dim</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">3</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden</span> <span class="o">=</span> <span class="p">[</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>             <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="computing-gradients-with-autodiff">
<h2>Computing Gradients with Autodiff<a class="headerlink" href="#computing-gradients-with-autodiff" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">w2</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span>
<span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-6</span>
<span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">w1</span> <span class="o">+</span> <span class="n">eps</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">))</span> <span class="o">/</span> <span class="n">eps</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>36.000003007075065
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)</span> <span class="o">-</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">))</span> <span class="o">/</span> <span class="n">eps</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>10.000000003174137
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">5.</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1637827037.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">5.</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gradients</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2375283804.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">gradients</span>

<span class="ne">NameError</span>: name &#39;gradients&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>

<span class="n">dz_dw1</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">dz_dw2</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4270280037.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">dz_dw1</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">dz_dw2</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the target tensor must be &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1059</span>             <span class="s2">&quot;floating (e.g. tf.float32) when calling GradientTape.gradient, &quot;</span>
<span class="ne">-&gt; </span><span class="mi">1060</span>             <span class="s2">&quot;got </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1061</span>       <span class="k">if</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">is_resource_variable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1062</span>         <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>

<span class="ne">AttributeError</span>: &#39;int&#39; object has no attribute &#39;dtype&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">(</span><span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>

<span class="n">dz_dw1</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span>
<span class="n">dz_dw2</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="c1"># works now!</span>
<span class="k">del</span> <span class="n">tape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">750316265.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">dz_dw1</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w1</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">dz_dw2</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span> <span class="c1"># works now!</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="k">del</span> <span class="n">tape</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the target tensor must be &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1059</span>             <span class="s2">&quot;floating (e.g. tf.float32) when calling GradientTape.gradient, &quot;</span>
<span class="ne">-&gt; </span><span class="mi">1060</span>             <span class="s2">&quot;got </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1061</span>       <span class="k">if</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">is_resource_variable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1062</span>         <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>

<span class="ne">AttributeError</span>: &#39;int&#39; object has no attribute &#39;dtype&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dz_dw1</span><span class="p">,</span> <span class="n">dz_dw2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">18353898.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">dz_dw1</span><span class="p">,</span> <span class="n">dz_dw2</span>

<span class="ne">NameError</span>: name &#39;dz_dw1&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">5.</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">3.</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gradients</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[None, None]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">tape</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">c1</span><span class="p">)</span>
    <span class="n">tape</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">c2</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">)</span>

<span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">c1</span><span class="p">,</span> <span class="n">c2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gradients</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Tensor: shape=(), dtype=float32, numpy=36.0&gt;,
 &lt;tf.Tensor: shape=(), dtype=float32, numpy=10.0&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">7.</span><span class="p">)</span>

<span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">([</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z3</span><span class="p">],</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2703892250.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">z3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">7.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">([</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z3</span><span class="p">],</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1054</span>     <span class="n">flat_targets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">   </span><span class="mi">1055</span>     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1056</span>       <span class="k">if</span> <span class="ow">not</span> <span class="n">backprop_util</span><span class="o">.</span><span class="n">IsTrainable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1057</span>         <span class="n">logging</span><span class="o">.</span><span class="n">vlog</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the target tensor must be &quot;</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop_util.py</span> in <span class="ni">IsTrainable</span><span class="nt">(tensor_or_dtype)</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>   <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>     <span class="n">dtype</span> <span class="o">=</span> <span class="n">tensor_or_dtype</span>
<span class="ne">---&gt; </span><span class="mi">58</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">as_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>   <span class="k">return</span> <span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span>                               <span class="n">dtypes</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/framework/dtypes.py</span> in <span class="ni">as_dtype</span><span class="nt">(type_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">719</span>     <span class="k">return</span> <span class="n">_INTERN_TABLE</span><span class="p">[</span><span class="n">type_value</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">720</span> 
<span class="ne">--&gt; </span><span class="mi">721</span>   <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot convert value </span><span class="si">%r</span><span class="s2"> to a TensorFlow DType.&quot;</span> <span class="o">%</span>
<span class="g g-Whitespace">    </span><span class="mi">722</span>                   <span class="p">(</span><span class="n">type_value</span><span class="p">,))</span>

<span class="ne">TypeError</span>: Cannot convert value 125.0 to a TensorFlow DType.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">(</span><span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z1</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">2.</span><span class="p">)</span>
    <span class="n">z2</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">5.</span><span class="p">)</span>
    <span class="n">z3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">7.</span><span class="p">)</span>

<span class="n">tf</span><span class="o">.</span><span class="n">reduce_sum</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span> <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">(</span><span class="n">z1</span><span class="p">,</span> <span class="n">z2</span><span class="p">,</span> <span class="n">z3</span><span class="p">)]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="k">del</span> <span class="n">tape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">236625885.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">z3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">7.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="nn">----&gt; 6 tf.reduce_sum(tf.stack([tape.gradient(z, [w1, w2]) for z</span> in <span class="nt">(z1, z2, z3)]), axis=0)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">del</span> <span class="n">tape</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/236625885.py</span> in <span class="ni">&lt;listcomp&gt;</span><span class="nt">(.0)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>     <span class="n">z3</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span> <span class="o">+</span> <span class="mf">7.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="nn">----&gt; 6 tf.reduce_sum(tf.stack([tape.gradient(z, [w1, w2]) for z</span> in <span class="nt">(z1, z2, z3)]), axis=0)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">del</span> <span class="n">tape</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1054</span>     <span class="n">flat_targets</span> <span class="o">=</span> <span class="p">[]</span>
<span class="g g-Whitespace">   </span><span class="mi">1055</span>     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">nest</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">target</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1056</span>       <span class="k">if</span> <span class="ow">not</span> <span class="n">backprop_util</span><span class="o">.</span><span class="n">IsTrainable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1057</span>         <span class="n">logging</span><span class="o">.</span><span class="n">vlog</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the target tensor must be &quot;</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop_util.py</span> in <span class="ni">IsTrainable</span><span class="nt">(tensor_or_dtype)</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>   <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">     </span><span class="mi">57</span>     <span class="n">dtype</span> <span class="o">=</span> <span class="n">tensor_or_dtype</span>
<span class="ne">---&gt; </span><span class="mi">58</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">as_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">59</span>   <span class="k">return</span> <span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span> <span class="ow">in</span> <span class="p">(</span><span class="n">dtypes</span><span class="o">.</span><span class="n">float16</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">60</span>                               <span class="n">dtypes</span><span class="o">.</span><span class="n">complex64</span><span class="p">,</span> <span class="n">dtypes</span><span class="o">.</span><span class="n">complex128</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/framework/dtypes.py</span> in <span class="ni">as_dtype</span><span class="nt">(type_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">719</span>     <span class="k">return</span> <span class="n">_INTERN_TABLE</span><span class="p">[</span><span class="n">type_value</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">720</span> 
<span class="ne">--&gt; </span><span class="mi">721</span>   <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot convert value </span><span class="si">%r</span><span class="s2"> to a TensorFlow DType.&quot;</span> <span class="o">%</span>
<span class="g g-Whitespace">    </span><span class="mi">722</span>                   <span class="p">(</span><span class="n">type_value</span><span class="p">,))</span>

<span class="ne">TypeError</span>: Cannot convert value 125.0 to a TensorFlow DType.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">(</span><span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hessian_tape</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">jacobian_tape</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
    <span class="n">jacobians</span> <span class="o">=</span> <span class="n">jacobian_tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>

<span class="n">hessians</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">hessian_tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">jacobian</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span> <span class="k">for</span> <span class="n">jacobian</span> <span class="ow">in</span> <span class="n">jacobians</span>
<span class="p">]</span>
<span class="k">del</span> <span class="n">hessian_tape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1068410245.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">jacobian_tape</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>         <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="ne">----&gt; </span><span class="mi">4</span>     <span class="n">jacobians</span> <span class="o">=</span> <span class="n">jacobian_tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">hessians</span> <span class="o">=</span> <span class="p">[</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1058</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the target tensor must be &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1059</span>             <span class="s2">&quot;floating (e.g. tf.float32) when calling GradientTape.gradient, &quot;</span>
<span class="ne">-&gt; </span><span class="mi">1060</span>             <span class="s2">&quot;got </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1061</span>       <span class="k">if</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">is_resource_variable</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1062</span>         <span class="k">with</span> <span class="bp">self</span><span class="p">:</span>

<span class="ne">AttributeError</span>: &#39;int&#39; object has no attribute &#39;dtype&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">jacobians</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">534333668.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">jacobians</span>

<span class="ne">NameError</span>: name &#39;jacobians&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">hessians</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1318638731.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">hessians</span>

<span class="ne">NameError</span>: name &#39;hessians&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">):</span>
    <span class="k">return</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">tf</span><span class="o">.</span><span class="n">stop_gradient</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">w1</span> <span class="o">*</span> <span class="n">w2</span><span class="p">)</span>

<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>

<span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:The dtype of the target tensor must be floating (e.g. tf.float32) when calling GradientTape.gradient, got tf.int32
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">AttributeError</span><span class="g g-Whitespace">                            </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3115436957.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> 
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">w1</span><span class="p">,</span> <span class="n">w2</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/eager/backprop.py</span> in <span class="ni">gradient</span><span class="nt">(self, target, sources, output_gradients, unconnected_gradients)</span>
<span class="g g-Whitespace">   </span><span class="mi">1072</span>             <span class="n">logging</span><span class="o">.</span><span class="n">WARN</span><span class="p">,</span> <span class="s2">&quot;The dtype of the source tensor must be &quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1073</span>             <span class="s2">&quot;floating (e.g. tf.float32) when calling GradientTape.gradient, &quot;</span>
<span class="ne">-&gt; </span><span class="mi">1074</span>             <span class="s2">&quot;got </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1075</span>       <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="s2">&quot;is_packed&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1076</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>

<span class="ne">AttributeError</span>: &#39;int&#39; object has no attribute &#39;dtype&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">100.</span><span class="p">)</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">my_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">997941361.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mf">100.</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">my_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">30.</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">))</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=30.0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mf">100.</span><span class="p">])</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">my_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4071896277.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mf">100.</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">my_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">custom_gradient</span>
<span class="k">def</span> <span class="nf">my_better_softplus</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="n">exp</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">my_softplus_gradients</span><span class="p">(</span><span class="n">grad</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">grad</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">exp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">exp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">my_softplus_gradients</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">my_better_softplus</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z</span> <span class="o">&gt;</span> <span class="mf">30.</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">tf</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mf">1000.</span><span class="p">])</span>
<span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">my_better_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">z</span><span class="p">,</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">181212960.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">([</span><span class="mf">1000.</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>     <span class="n">z</span> <span class="o">=</span> <span class="n">my_better_softplus</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">z</span><span class="p">,</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="n">x</span><span class="p">])</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="computing-gradients-using-autodiff">
<h1>Computing Gradients Using Autodiff<a class="headerlink" href="#computing-gradients-using-autodiff" title="Permalink to this headline">¶</a></h1>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">l2_reg</span> <span class="o">=</span> <span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span>
                 <span class="n">kernel_initializer</span><span class="o">=</span><span class="s2">&quot;he_normal&quot;</span><span class="p">,</span>
                 <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2_reg</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">kernel_regularizer</span><span class="o">=</span><span class="n">l2_reg</span><span class="p">)</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2574096786.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">l2_reg</span> <span class="o">=</span> <span class="n">regularizers</span><span class="o">.</span><span class="n">l2</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> 
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>                  <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;elu&quot;</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">random_batch</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">batch_size</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_status_bar</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">loss</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">metrics</span> <span class="ow">or</span> <span class="p">[])])</span>
    <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">iteration</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">total</span><span class="si">}</span><span class="s2"> - &quot;</span> <span class="o">+</span> <span class="n">metrics</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>

<span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="n">mean_square</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mean_square&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>
    <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">mean_square</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">print_status_bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">mean_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_square</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3875490208.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="kn">import</span> <span class="nn">time</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="ne">----&gt; </span><span class="mi">3</span> <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">mean_square</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mean_square&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">534</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Mean</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>         <span class="n">reduction</span><span class="o">=</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, reduction, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
<span class="ne">--&gt; </span><span class="mi">373</span>     <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>         <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span>     <span class="k">if</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">SUM_OVER_BATCH_SIZE</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<p>A fancier version with a progress bar:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">progress_bar</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">running</span> <span class="o">=</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">total</span>
    <span class="n">c</span> <span class="o">=</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">running</span> <span class="k">else</span> <span class="s2">&quot;=&quot;</span>
    <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">iteration</span> <span class="o">//</span> <span class="n">total</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s2">&quot;{{:-</span><span class="si">{}</span><span class="s2">d}}/{{}} [{{}}]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">total</span><span class="p">)))</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="s2">&quot;=&quot;</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="n">c</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">size</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span>
    <span class="k">return</span> <span class="n">fmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">params</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">progress_bar</span><span class="p">(</span><span class="mi">3500</span><span class="p">,</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39; 3500/10000 [=&gt;....]&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">print_status_bar</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="n">loss</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
    <span class="n">metrics</span> <span class="o">=</span> <span class="s2">&quot; - &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
        <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="p">[</span><span class="n">loss</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">metrics</span> <span class="ow">or</span> <span class="p">[])])</span>
    <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">iteration</span> <span class="o">&lt;</span> <span class="n">total</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\r</span><span class="si">{</span><span class="n">progress_bar</span><span class="p">(</span><span class="n">iteration</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span><span class="si">}</span><span class="s2"> - </span><span class="si">{</span><span class="n">metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="n">mean_square</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mean_square&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>
    <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
    <span class="n">mean_square</span><span class="p">(</span><span class="n">i</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">print_status_bar</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="n">mean_loss</span><span class="p">,</span> <span class="p">[</span><span class="n">mean_square</span><span class="p">])</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">767336705.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;loss&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">mean_square</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;mean_square&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">50</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">loss</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">i</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">534</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Mean</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>         <span class="n">reduction</span><span class="o">=</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, reduction, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
<span class="ne">--&gt; </span><span class="mi">373</span>     <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>         <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span>     <span class="k">if</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">SUM_OVER_BATCH_SIZE</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span>
<span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/optimizer_v2/optimizer_v2.py:355: UserWarning: The `lr` argument is deprecated, use `learning_rate` instead.
  warnings.warn(
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">776464015.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">mean_squared_error</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">MeanAbsoluteError</span><span class="p">()]</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">534</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Mean</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>         <span class="n">reduction</span><span class="o">=</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, reduction, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
<span class="ne">--&gt; </span><span class="mi">373</span>     <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>         <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span>     <span class="k">if</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">SUM_OVER_BATCH_SIZE</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
            <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
        <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">variable</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
        <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrix</span><span class="p">:</span>
            <span class="n">metric</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">print_status_bar</span><span class="p">(</span><span class="n">step</span> <span class="o">*</span> <span class="n">batch_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="n">mean_loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
    <span class="n">print_status_bar</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_train</span><span class="p">),</span> <span class="n">mean_loss</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrix</span><span class="p">:</span>
        <span class="n">metric</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Epoch 1/5
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4094603371.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>         <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>         <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">6</span>             <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>             <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>             <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">tqdm.notebook</span> <span class="kn">import</span> <span class="n">trange</span>
    <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
    <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;All epochs&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">epochs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Epoch </span><span class="si">{}</span><span class="s2">/</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">n_epochs</span><span class="p">))</span> <span class="k">as</span> <span class="n">steps</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                    <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                    <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
                        <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
                        <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
                    <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">variable</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
                    <span class="n">status</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                    <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                    <span class="n">status</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_loss</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="p">:</span>
                        <span class="n">metric</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                        <span class="n">status</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                    <span class="n">steps</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">metric</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;To run this cell, please install tqdm, ipywidgets and restart Jupyter&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "88a67100117944f4ac9228960fd9f885", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "6accbe827c3f440fa71605cd8ebfaadf", "version_major": 2, "version_minor": 0}
</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">548108343.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>                     <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>                     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">12</span>                         <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">13</span>                         <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>                         <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="section" id="tensorflow-functions">
<h2>TensorFlow Functions<a class="headerlink" href="#tensorflow-functions" title="Permalink to this headline">¶</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cube</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>8
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf_cube</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">cube</span><span class="p">)</span>
<span class="n">tf_cube</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.eager.def_function.Function at 0x14c47edc0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf_cube</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2021-10-09 13:28:51.795340: I tensorflow/compiler/mlir/mlir_graph_optimization_pass.cc:185] None of the MLIR Optimization Passes are enabled (registered 2)
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=8&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tf_cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;
</pre></div>
</div>
</div>
</div>
<div class="section" id="tf-functions-and-concrete-functions">
<h3>TF Functions and Concrete Functions<a class="headerlink" href="#tf-functions-and-concrete-functions" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
<span class="n">concrete_function</span><span class="o">.</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.framework.func_graph.FuncGraph at 0x14c5ddc40&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span> <span class="ow">is</span> <span class="n">tf_cube</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="exploring-function-definitions-and-graphs">
<h3>Exploring Function Definitions and Graphs<a class="headerlink" href="#exploring-function-definitions-and-graphs" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span><span class="o">.</span><span class="n">graph</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tensorflow.python.framework.func_graph.FuncGraph at 0x14c5ddc40&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ops</span> <span class="o">=</span> <span class="n">concrete_function</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()</span>
<span class="n">ops</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Operation &#39;x&#39; type=Placeholder&gt;,
 &lt;tf.Operation &#39;pow/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;pow&#39; type=Pow&gt;,
 &lt;tf.Operation &#39;Identity&#39; type=Identity&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pow_op</span> <span class="o">=</span> <span class="n">ops</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
<span class="nb">list</span><span class="p">(</span><span class="n">pow_op</span><span class="o">.</span><span class="n">inputs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Tensor &#39;x:0&#39; shape=() dtype=float32&gt;,
 &lt;tf.Tensor &#39;pow/y:0&#39; shape=() dtype=float32&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pow_op</span><span class="o">.</span><span class="n">outputs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Tensor &#39;pow:0&#39; shape=() dtype=float32&gt;]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operation_by_name</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Operation &#39;x&#39; type=Placeholder&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_tensor_by_name</span><span class="p">(</span><span class="s1">&#39;Identity:0&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor &#39;Identity:0&#39; shape=() dtype=float32&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">concrete_function</span><span class="o">.</span><span class="n">function_def</span><span class="o">.</span><span class="n">signature</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>name: &quot;__inference_cube_578&quot;
input_arg {
  name: &quot;x&quot;
  type: DT_FLOAT
}
output_arg {
  name: &quot;identity&quot;
  type: DT_FLOAT
}
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="how-tf-functions-trace-python-functions-to-extract-their-computation-graphs">
<h3>How TF Functions Trace Python Functions to Extract Their Computation Graphs<a class="headerlink" href="#how-tf-functions-trace-python-functions-to-extract-their-computation-graphs" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">tf_cube</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;print:&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>print: Tensor(&quot;x:0&quot;, shape=(), dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=float32, numpy=8.0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">]]))</span> <span class="c1"># New shape: trace!</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">3.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">],</span> <span class="p">[</span><span class="mf">5.</span><span class="p">,</span> <span class="mf">6.</span><span class="p">]]))</span> <span class="c1"># New shape: trace!</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">tf_cube</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">([[</span><span class="mf">7.</span><span class="p">,</span> <span class="mf">8.</span><span class="p">],</span> <span class="p">[</span><span class="mf">9.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">],</span> <span class="p">[</span><span class="mf">11.</span><span class="p">,</span> <span class="mf">12.</span><span class="p">]]))</span> <span class="c1"># New shape: trace!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>print: 2
print: 3
print: Tensor(&quot;x:0&quot;, shape=(1, 2), dtype=float32)
print: Tensor(&quot;x:0&quot;, shape=(2, 2), dtype=float32)
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WARNING:tensorflow:5 out of the last 5 calls to &lt;function tf_cube at 0x14c5f1280&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>print: Tensor(&quot;x:0&quot;, shape=(3, 2), dtype=float32)
WARNING:tensorflow:6 out of the last 6 calls to &lt;function tf_cube at 0x14c5f1280&gt; triggered tf.function retracing. Tracing is expensive and the excessive number of tracings could be due to (1) creating @tf.function repeatedly in a loop, (2) passing tensors with different shapes, (3) passing Python objects instead of tensors. For (1), please define your @tf.function outside of the loop. For (2), @tf.function has experimental_relax_shapes=True option that relaxes argument shapes that can avoid unnecessary retracing. For (3), please refer to https://www.tensorflow.org/guide/function#controlling_retracing and https://www.tensorflow.org/api_docs/python/tf/function for  more details.
</pre></div>
</div>
</div>
</div>
<p>It is also possible to specify a particular input signature:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="n">input_signature</span><span class="o">=</span><span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">TensorSpec</span><span class="p">([</span><span class="kc">None</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">],</span> <span class="n">tf</span><span class="o">.</span><span class="n">float32</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing&quot;</span><span class="p">,</span> <span class="n">images</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">images</span><span class="p">[:,</span> <span class="p">::</span><span class="mi">2</span><span class="p">,</span> <span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="c1"># drop half the rows and columns</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">img_batch_1</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
<span class="n">img_batch_2</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">])</span>
<span class="n">preprocessed_images</span> <span class="o">=</span> <span class="n">shrink</span><span class="p">(</span><span class="n">img_batch_1</span><span class="p">)</span> <span class="c1"># Traces the function.</span>
<span class="n">preprocessed_images</span> <span class="o">=</span> <span class="n">shrink</span><span class="p">(</span><span class="n">img_batch_2</span><span class="p">)</span> <span class="c1"># Reuses the same concrete function.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Tracing Tensor(&quot;images:0&quot;, shape=(None, 28, 28), dtype=float32)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">img_batch_3</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">preprocessed_images</span> <span class="o">=</span> <span class="n">shrink</span><span class="p">(</span><span class="n">img_batch_3</span><span class="p">)</span>  <span class="c1"># rejects unexpected types or shapes</span>
<span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Python inputs incompatible with input_signature:
  inputs: (
    tf.Tensor(
[[[0.7413678  0.62854624]
  [0.01738465 0.3431449 ]]

 [[0.51063764 0.3777541 ]
  [0.07321596 0.02137029]]], shape=(2, 2, 2), dtype=float32))
  input_signature: (
    TensorSpec(shape=(None, 28, 28), dtype=tf.float32, name=None))
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="using-autograph-to-capture-control-flow">
<h3>Using Autograph To Capture Control Flow<a class="headerlink" href="#using-autograph-to-capture-control-flow" title="Permalink to this headline">¶</a></h3>
<p>A “static” <code class="docutils literal notranslate"><span class="pre">for</span></code> loop using <code class="docutils literal notranslate"><span class="pre">range()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">add_10</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_10</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=15&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_10</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Operation &#39;x&#39; type=Placeholder&gt;,
 &lt;tf.Operation &#39;add/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_1/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_1&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_2/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_2&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_3/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_3&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_4/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_4&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_5/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_5&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_6/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_6&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_7/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_7&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_8/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_8&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;add_9/y&#39; type=Const&gt;,
 &lt;tf.Operation &#39;add_9&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;Identity&#39; type=Identity&gt;]
</pre></div>
</div>
</div>
</div>
<p>A “dynamic” loop using <code class="docutils literal notranslate"><span class="pre">tf.while_loop()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">add_10</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">condition</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">tf</span><span class="o">.</span><span class="n">less</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">body</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">tf</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">final_i</span><span class="p">,</span> <span class="n">final_x</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">while_loop</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="p">[</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">x</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">final_x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_10</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;tf.Tensor: shape=(), dtype=int32, numpy=15&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_10</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Operation &#39;x&#39; type=Placeholder&gt;,
 &lt;tf.Operation &#39;Const&#39; type=Const&gt;,
 &lt;tf.Operation &#39;while/maximum_iterations&#39; type=Const&gt;,
 &lt;tf.Operation &#39;while/loop_counter&#39; type=Const&gt;,
 &lt;tf.Operation &#39;while&#39; type=StatelessWhile&gt;,
 &lt;tf.Operation &#39;Identity&#39; type=Identity&gt;]
</pre></div>
</div>
</div>
</div>
<p>A “dynamic” <code class="docutils literal notranslate"><span class="pre">for</span></code> loop using <code class="docutils literal notranslate"><span class="pre">tf.range()</span></code> (captured by autograph):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">add_10</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">add_10</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">graph</span><span class="o">.</span><span class="n">get_operations</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;tf.Operation &#39;x&#39; type=Placeholder&gt;,
 &lt;tf.Operation &#39;range/start&#39; type=Const&gt;,
 &lt;tf.Operation &#39;range/limit&#39; type=Const&gt;,
 &lt;tf.Operation &#39;range/delta&#39; type=Const&gt;,
 &lt;tf.Operation &#39;range&#39; type=Range&gt;,
 &lt;tf.Operation &#39;sub&#39; type=Sub&gt;,
 &lt;tf.Operation &#39;floordiv&#39; type=FloorDiv&gt;,
 &lt;tf.Operation &#39;mod&#39; type=FloorMod&gt;,
 &lt;tf.Operation &#39;zeros_like&#39; type=Const&gt;,
 &lt;tf.Operation &#39;NotEqual&#39; type=NotEqual&gt;,
 &lt;tf.Operation &#39;Cast&#39; type=Cast&gt;,
 &lt;tf.Operation &#39;add&#39; type=AddV2&gt;,
 &lt;tf.Operation &#39;zeros_like_1&#39; type=Const&gt;,
 &lt;tf.Operation &#39;Maximum&#39; type=Maximum&gt;,
 &lt;tf.Operation &#39;while/maximum_iterations&#39; type=Const&gt;,
 &lt;tf.Operation &#39;while/loop_counter&#39; type=Const&gt;,
 &lt;tf.Operation &#39;while&#39; type=StatelessWhile&gt;,
 &lt;tf.Operation &#39;Identity&#39; type=Identity&gt;]
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="handling-variables-and-other-resources-in-tf-functions">
<h3>Handling Variables and Other Resources in TF Functions<a class="headerlink" href="#handling-variables-and-other-resources-in-tf-functions" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">887368894.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="n">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1361776033.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">increment</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;increment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function_def</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">function_def</span>
<span class="n">function_def</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">input_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4274471741.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">function_def</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span><span class="o">.</span><span class="n">function_def</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">function_def</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">input_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;increment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2513565623.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> 
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="k">return</span> <span class="n">counter</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">increment</span><span class="p">()</span>
<span class="n">increment</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4134138628.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">increment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">increment</span><span class="p">()</span>

<span class="ne">NameError</span>: name &#39;increment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function_def</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">()</span><span class="o">.</span><span class="n">function_def</span>
<span class="n">function_def</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">input_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">802759583.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">function_def</span> <span class="o">=</span> <span class="n">increment</span><span class="o">.</span><span class="n">get_concrete_function</span><span class="p">()</span><span class="o">.</span><span class="n">function_def</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">function_def</span><span class="o">.</span><span class="n">signature</span><span class="o">.</span><span class="n">input_arg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="ne">NameError</span>: name &#39;increment&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">increment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1899385314.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">c</span><span class="o">.</span><span class="n">increment</span><span class="p">()</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/1129297875.py</span> in <span class="ni">__init__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="k">class</span> <span class="nc">Counter</span><span class="p">:</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">3</span>         <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
<span class="k">def</span> <span class="nf">add_10</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">tf</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="nb">print</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">add_10</span><span class="o">.</span><span class="n">python_function</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>def tf__add(x):
    with ag__.FunctionScope(&#39;add_10&#39;, &#39;fscope&#39;, ag__.ConversionOptions(recursive=True, user_requested=True, optional_features=(), internal_convert_user_code=True)) as fscope:
        do_return = False
        retval_ = ag__.UndefinedReturnValue()

        def get_state():
            return (x,)

        def set_state(vars_):
            nonlocal x
            (x,) = vars_

        def loop_body(itr):
            nonlocal x
            i = itr
            x = ag__.ld(x)
            x += 1
        i = ag__.Undefined(&#39;i&#39;)
        ag__.for_stmt(ag__.converted_call(ag__.ld(tf).range, (10,), None, fscope), None, loop_body, get_state, set_state, (&#39;x&#39;,), {&#39;iterate_names&#39;: &#39;i&#39;})
        try:
            do_return = True
            retval_ = ag__.ld(x)
        except:
            do_return = False
            raise
        return fscope.ret(retval_, do_return)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_tf_code</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;python_function&quot;</span><span class="p">):</span>
        <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">python_function</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">autograph</span><span class="o">.</span><span class="n">to_code</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;```python</span><span class="se">\n</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="se">\n</span><span class="s1">```&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">display_tf_code</span><span class="p">(</span><span class="n">add_10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">tf__add</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ag__</span><span class="o">.</span><span class="n">FunctionScope</span><span class="p">(</span><span class="s1">&#39;add_10&#39;</span><span class="p">,</span> <span class="s1">&#39;fscope&#39;</span><span class="p">,</span> <span class="n">ag__</span><span class="o">.</span><span class="n">ConversionOptions</span><span class="p">(</span><span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">user_requested</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">optional_features</span><span class="o">=</span><span class="p">(),</span> <span class="n">internal_convert_user_code</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="k">as</span> <span class="n">fscope</span><span class="p">:</span>
        <span class="n">do_return</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">retval_</span> <span class="o">=</span> <span class="n">ag__</span><span class="o">.</span><span class="n">UndefinedReturnValue</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_state</span><span class="p">():</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="p">,)</span>

        <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="n">vars_</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">x</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,)</span> <span class="o">=</span> <span class="n">vars_</span>

        <span class="k">def</span> <span class="nf">loop_body</span><span class="p">(</span><span class="n">itr</span><span class="p">):</span>
            <span class="k">nonlocal</span> <span class="n">x</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">itr</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">ag__</span><span class="o">.</span><span class="n">ld</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">ag__</span><span class="o">.</span><span class="n">Undefined</span><span class="p">(</span><span class="s1">&#39;i&#39;</span><span class="p">)</span>
        <span class="n">ag__</span><span class="o">.</span><span class="n">for_stmt</span><span class="p">(</span><span class="n">ag__</span><span class="o">.</span><span class="n">converted_call</span><span class="p">(</span><span class="n">ag__</span><span class="o">.</span><span class="n">ld</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span><span class="o">.</span><span class="n">range</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="p">,),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fscope</span><span class="p">),</span> <span class="kc">None</span><span class="p">,</span> <span class="n">loop_body</span><span class="p">,</span> <span class="n">get_state</span><span class="p">,</span> <span class="n">set_state</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;iterate_names&#39;</span><span class="p">:</span> <span class="s1">&#39;i&#39;</span><span class="p">})</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">do_return</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">retval_</span> <span class="o">=</span> <span class="n">ag__</span><span class="o">.</span><span class="n">ld</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">do_return</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">fscope</span><span class="o">.</span><span class="n">ret</span><span class="p">(</span><span class="n">retval_</span><span class="p">,</span> <span class="n">do_return</span><span class="p">)</span>

</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="using-tf-functions-with-tf-keras-or-not">
<h2>Using TF Functions with tf.keras (or Not)<a class="headerlink" href="#using-tf-functions-with-tf-keras-or-not" title="Permalink to this headline">¶</a></h2>
<p>By default, tf.keras will automatically convert your custom code into TF Functions, no need to use
<code class="docutils literal notranslate"><span class="pre">tf.function()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Custom loss function</span>
<span class="k">def</span> <span class="nf">my_mse</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing loss my_mse()&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Custom metric function</span>
<span class="k">def</span> <span class="nf">my_mae</span><span class="p">(</span><span class="n">y_true</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing metric my_mae()&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_true</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Custom layer</span>
<span class="k">class</span> <span class="nc">MyDense</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="n">units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">activation</span> <span class="o">=</span> <span class="n">activations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">activation</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;kernel&#39;</span><span class="p">,</span>
                                      <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">input_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">),</span>
                                      <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;uniform&#39;</span><span class="p">,</span>
                                      <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">biases</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;bias&#39;</span><span class="p">,</span>
                                      <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">,</span> <span class="p">),</span>
                                      <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">,</span>
                                      <span class="n">trainable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shape</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing MyDense.call()&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">activation</span><span class="p">(</span><span class="n">X</span> <span class="o">@</span> <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">biases</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>


<span class="c1"># Custom model</span>
<span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hidden2</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">input</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing MyModel.call()&quot;</span><span class="p">)</span>
        <span class="n">hidden1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>
        <span class="n">hidden2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hidden2</span><span class="p">(</span><span class="n">hidden1</span><span class="p">)</span>
        <span class="n">concat</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="nb">input</span><span class="p">,</span> <span class="n">hidden2</span><span class="p">])</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_</span><span class="p">(</span><span class="n">concat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4247402733.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">     </span><span class="mi">21</span> 
<span class="g g-Whitespace">     </span><span class="mi">22</span> 
<span class="ne">---&gt; </span><span class="mi">23</span> <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/4247402733.py</span> in <span class="ni">__init__</span><span class="nt">(self, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">9</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden2</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">my_mae</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4230279339.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">my_mae</span><span class="p">])</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
          <span class="n">y_train</span><span class="p">,</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">450956516.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">,</span> <span class="n">y_valid</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">,</span> <span class="n">y_test</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>You can turn this off by creating the model with <code class="docutils literal notranslate"><span class="pre">dynamic=True</span></code> (or calling <code class="docutils literal notranslate"><span class="pre">super().__init__(dynamic=True,</span> <span class="pre">**kwargs)</span></code> in the model’s constructor):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">my_mae</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2237424075.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">(</span><span class="n">dynamic</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">my_mae</span><span class="p">])</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/4247402733.py</span> in <span class="ni">__init__</span><span class="nt">(self, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">9</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden2</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<p>Not the custom code will be called at each iteration. Let’s fit, validate and evaluate with tiny datasets to avoid getting too much output:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
          <span class="n">y_train</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[:</span><span class="mi">64</span><span class="p">]),</span>
          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1721767620.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[:</span><span class="mi">64</span><span class="p">]),</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>           <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
<p>Alternatively, you can compile a model with <code class="docutils literal notranslate"><span class="pre">run_eagerly=True</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span>
              <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span>
              <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="n">my_mae</span><span class="p">],</span>
              <span class="n">run_eagerly</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1435238390.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">MyModel</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">my_mse</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>               <span class="n">optimizer</span><span class="o">=</span><span class="s2">&quot;nadam&quot;</span><span class="p">,</span>

<span class="nn">/var/folders/93/795zm8c93m16_92qkk86t0_r0000gn/T/ipykernel_24022/4247402733.py</span> in <span class="ni">__init__</span><span class="nt">(self, **kwargs)</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="k">class</span> <span class="nc">MyModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="ne">----&gt; </span><span class="mi">9</span>         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden1</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span>         <span class="bp">self</span><span class="o">.</span><span class="n">hidden2</span> <span class="o">=</span> <span class="n">MyDense</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_steps_per_execution</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span> 
<span class="ne">--&gt; </span><span class="mi">289</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_init_batch_counters</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_base_model_initialized</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span>     <span class="c1"># `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span>     <span class="n">agg</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">VariableAggregation</span><span class="o">.</span><span class="n">ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_train_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_test_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;int64&#39;</span><span class="p">,</span> <span class="n">aggregation</span><span class="o">=</span><span class="n">agg</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_predict_counter</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kws</span><span class="p">:</span> <span class="n">default_variable_creator_v2</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kws</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>   <span class="n">shape</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span> 
<span class="ne">-&gt; </span><span class="mi">2662</span>   <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span>       <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
          <span class="n">y_train</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
          <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
          <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[:</span><span class="mi">64</span><span class="p">]),</span>
          <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_test</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1721767620.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span>           <span class="n">y_train</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span>           <span class="n">epochs</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span>           <span class="n">validation_data</span><span class="o">=</span><span class="p">(</span><span class="n">X_valid_scaled</span><span class="p">[:</span><span class="mi">64</span><span class="p">],</span> <span class="n">y_valid</span><span class="p">[:</span><span class="mi">64</span><span class="p">]),</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>           <span class="n">verbose</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="custom-optimizers">
<h2>Custom Optimizers<a class="headerlink" href="#custom-optimizers" title="Permalink to this headline">¶</a></h2>
<p>Defining custom optimizers is not very common, but in case you are one of the happy few who gets to write one, here is an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyMomentumOptimizer</span><span class="p">(</span><span class="n">optimizers</span><span class="o">.</span><span class="n">Optimizer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">learning_rate</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
                 <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MyMomentumOptimizer&quot;</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Call super().__init__() and use _set_hyper() to store hyperparameters&quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_hyper</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">,</span>
                        <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;lr&quot;</span><span class="p">,</span>
                                   <span class="n">learning_rate</span><span class="p">))</span>  <span class="c1"># handle lr=learning_rate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_hyper</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initial_decay</span><span class="p">)</span>  <span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_hyper</span><span class="p">(</span><span class="s2">&quot;momentum&quot;</span><span class="p">,</span> <span class="n">momentum</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_create_slots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_list</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;For each model variable, create the optimizer variable associated with it.</span>
<span class="sd">        TensorFlow calls these optimizer variables &quot;slots&quot;.</span>
<span class="sd">        For momentum optimization, we need one momentum slot per model variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">var_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_slot</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;momentum&quot;</span><span class="p">)</span>

    <span class="nd">@tf</span><span class="o">.</span><span class="n">function</span>
    <span class="k">def</span> <span class="nf">_resource_apply_dense</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update the slots and perform one optimization step for one model variable</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">var_dtype</span> <span class="o">=</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
        <span class="n">lr_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_decayed_lr</span><span class="p">(</span><span class="n">var_dtype</span><span class="p">)</span>  <span class="c1"># handle learning rate decay</span>
        <span class="n">momentum_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_slot</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;momentum&quot;</span><span class="p">)</span>
        <span class="n">momentum_hyper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_hyper</span><span class="p">(</span><span class="s2">&quot;momentum&quot;</span><span class="p">,</span> <span class="n">var_dtype</span><span class="p">)</span>
        <span class="n">momentum_var</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">momentum_var</span> <span class="o">*</span> <span class="n">momentum_hyper</span> <span class="o">-</span>
                            <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="n">momentum_hyper</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad</span><span class="p">)</span>
        <span class="n">var</span><span class="o">.</span><span class="n">assign_add</span><span class="p">(</span><span class="n">momentum_var</span> <span class="o">*</span> <span class="n">lr_t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resource_apply_sparse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">base_config</span><span class="p">,</span>
            <span class="s2">&quot;learning_rate&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_hyperparameter</span><span class="p">(</span><span class="s2">&quot;learning_rate&quot;</span><span class="p">),</span>
            <span class="s2">&quot;decay&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_hyperparameter</span><span class="p">(</span><span class="s2">&quot;decay&quot;</span><span class="p">),</span>
            <span class="s2">&quot;momentum&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_serialize_hyperparameter</span><span class="p">(</span><span class="s2">&quot;momentum&quot;</span><span class="p">),</span>
        <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">])])</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">MyMomentumOptimizer</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2049637483.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span><span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">8</span><span class="p">])])</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="s2">&quot;mse&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">MyMomentumOptimizer</span><span class="p">())</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="exercises">
<h1>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="implement-a-custom-layer-that-performs-layer-normalization">
<h1>12. Implement a custom layer that performs <em>Layer Normalization</em><a class="headerlink" href="#implement-a-custom-layer-that-performs-layer-normalization" title="Permalink to this headline">¶</a></h1>
<p><em>We will use this type of layer in Chapter 15 when using Recurrent Neural Networks.</em></p>
<div class="section" id="a">
<h2>a.<a class="headerlink" href="#a" title="Permalink to this headline">¶</a></h2>
<p><em>Exercise: The <code class="docutils literal notranslate"><span class="pre">build()</span></code> method should define two trainable weights <em>α</em> and <em>β</em>, both of shape <code class="docutils literal notranslate"><span class="pre">input_shape[-1:]</span></code> and data type <code class="docutils literal notranslate"><span class="pre">tf.float32</span></code>. <em>α</em> should be initialized with 1s, and <em>β</em> with 0s.</em></p>
<p>Solution: see below.</p>
</div>
<div class="section" id="b">
<h2>b.<a class="headerlink" href="#b" title="Permalink to this headline">¶</a></h2>
<p><em>Exercise: The <code class="docutils literal notranslate"><span class="pre">call()</span></code> method should compute the mean</em> μ <em>and standard deviation</em> σ <em>of each instance’s features. For this, you can use <code class="docutils literal notranslate"><span class="pre">tf.nn.moments(inputs,</span> <span class="pre">axes=-1,</span> <span class="pre">keepdims=True)</span></code>, which returns the mean μ and the variance σ<sup>2</sup> of all instances (compute the square root of the variance to get the standard deviation). Then the function should compute and return <em>α</em>⊗(<em>X</em> - μ)/(σ + ε) + <em>β</em>, where ⊗ represents itemwise multiplication (<code class="docutils literal notranslate"><span class="pre">*</span></code>) and ε is a smoothing term (small constant to avoid division by zero, e.g., 0.001).</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LayerNormalization</span><span class="p">(</span><span class="n">layers</span><span class="o">.</span><span class="n">Layer</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eps</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span>
                                     <span class="n">shape</span><span class="o">=</span><span class="n">batch_input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span>
                                     <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;ones&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;beta&quot;</span><span class="p">,</span>
                                    <span class="n">shape</span><span class="o">=</span><span class="n">batch_input_shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span>
                                    <span class="n">initializer</span><span class="o">=</span><span class="s2">&quot;zeros&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">batch_input_shape</span><span class="p">)</span>  <span class="c1"># must be at the end</span>

    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="n">mean</span><span class="p">,</span> <span class="n">variance</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">moments</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">mean</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span> <span class="o">+</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">))</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span>

    <span class="k">def</span> <span class="nf">compute_output_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_input_shape</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">batch_input_shape</span>

    <span class="k">def</span> <span class="nf">get_config</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">base_config</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_config</span><span class="p">()</span>
        <span class="k">return</span> <span class="p">{</span><span class="o">**</span><span class="n">base_config</span><span class="p">,</span> <span class="s2">&quot;eps&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">eps</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Note that making <em>ε</em> a hyperparameter (<code class="docutils literal notranslate"><span class="pre">eps</span></code>) was not compulsory. Also note that it’s preferable to compute <code class="docutils literal notranslate"><span class="pre">tf.sqrt(variance</span> <span class="pre">+</span> <span class="pre">self.eps)</span></code> rather than <code class="docutils literal notranslate"><span class="pre">tf.sqrt(variance)</span> <span class="pre">+</span> <span class="pre">self.eps</span></code>. Indeed, the derivative of sqrt(z) is undefined when z=0, so training will bomb whenever the variance vector has at least one component equal to 0. Adding <em>ε</em> within the square root guarantees that this will never happen.</p>
</div>
<div class="section" id="c">
<h2>c.<a class="headerlink" href="#c" title="Permalink to this headline">¶</a></h2>
<p><em>Exercise: Ensure that your custom layer produces the same (or very nearly the same) output as the <code class="docutils literal notranslate"><span class="pre">keras.layers.LayerNormalization</span></code> layer.</em></p>
<p>Let’s create one instance of each class, apply them to some data (e.g., the training set), and ensure that the difference is negligeable.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>

<span class="n">custom_layer_norm</span> <span class="o">=</span> <span class="n">LayerNormalization</span><span class="p">()</span>
<span class="n">keras_layer_norm</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">LayerNormalization</span><span class="p">()</span>

<span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">keras_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">custom_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">3038938027.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> 
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
<span class="ne">----&gt; </span><span class="mi">7</span>     <span class="n">losses</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">keras_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">custom_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">__call__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">1028</span>       <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">name_scope</span><span class="p">(</span><span class="n">name_scope</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1029</span>         <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">built</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1030</span>           <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_build</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1031</span> 
<span class="g g-Whitespace">   </span><span class="mi">1032</span>         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_autocast</span><span class="p">:</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">_maybe_build</span><span class="nt">(self, inputs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2657</span>         <span class="c1"># operations.</span>
<span class="g g-Whitespace">   </span><span class="mi">2658</span>         <span class="k">with</span> <span class="n">tf_utils</span><span class="o">.</span><span class="n">maybe_init_scope</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">2659</span>           <span class="bp">self</span><span class="o">.</span><span class="n">build</span><span class="p">(</span><span class="n">input_shapes</span><span class="p">)</span>  <span class="c1"># pylint:disable=not-callable</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span>       <span class="c1"># We must set also ensure that the layer is marked as built, and the build</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span>       <span class="c1"># shape is stored since user defined build functions may not be calling</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/layers/normalization/layer_normalization.py</span> in <span class="ni">build</span><span class="nt">(self, input_shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">230</span>     <span class="n">param_shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">input_shape</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">axis</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">231</span>     <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">232</span>       <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">233</span>           <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gamma&#39;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">234</span>           <span class="n">shape</span><span class="o">=</span><span class="n">param_shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<p>Yep, that’s close enough. To be extra sure, let’s make alpha and beta completely random and compare again:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">random_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">random_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<span class="n">custom_layer_norm</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">random_alpha</span><span class="p">,</span> <span class="n">random_beta</span><span class="p">])</span>
<span class="n">keras_layer_norm</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">random_alpha</span><span class="p">,</span> <span class="n">random_beta</span><span class="p">])</span>

<span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span>
    <span class="n">losses</span><span class="o">.</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">keras_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">custom_layer_norm</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1751109424.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">2</span> <span class="n">random_beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> 
<span class="ne">----&gt; </span><span class="mi">4</span> <span class="n">custom_layer_norm</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">random_alpha</span><span class="p">,</span> <span class="n">random_beta</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">keras_layer_norm</span><span class="o">.</span><span class="n">set_weights</span><span class="p">([</span><span class="n">random_alpha</span><span class="p">,</span> <span class="n">random_beta</span><span class="p">])</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">set_weights</span><span class="nt">(self, weights)</span>
<span class="g g-Whitespace">   </span><span class="mi">1778</span> 
<span class="g g-Whitespace">   </span><span class="mi">1779</span>     <span class="k">if</span> <span class="n">expected_num_weights</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
<span class="ne">-&gt; </span><span class="mi">1780</span>       <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1781</span>           <span class="s1">&#39;You called `set_weights(weights)` on layer &quot;</span><span class="si">%s</span><span class="s1">&quot; &#39;</span>
<span class="g g-Whitespace">   </span><span class="mi">1782</span>           <span class="s1">&#39;with a weight list of length </span><span class="si">%s</span><span class="s1">, but the layer was &#39;</span>

<span class="ne">ValueError</span>: You called `set_weights(weights)` on layer &quot;layer_normalization&quot; with a weight list of length 2, but the layer was expecting 0 weights. Provided weights: [array([0.37454012, 0.95071431, 0.73199394, 0.5986...
</pre></div>
</div>
</div>
</div>
<p>Still a negligeable difference! Our custom layer works fine.</p>
</div>
<div class="section" id="train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset">
<h2>13. Train a model using a custom training loop to tackle the Fashion MNIST dataset<a class="headerlink" href="#train-a-model-using-a-custom-training-loop-to-tackle-the-fashion-mnist-dataset" title="Permalink to this headline">¶</a></h2>
<p><em>The Fashion MNIST dataset was introduced in Chapter 10.</em></p>
<div class="section" id="id2">
<h3>a.<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h3>
<p><em>Exercise: Display the epoch, iteration, mean training loss, and mean accuracy over each epoch (updated at each iteration), as well as the validation loss and accuracy at the end of each epoch.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">X_train_full</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">),</span> <span class="p">(</span><span class="n">X_test</span><span class="p">,</span>
                               <span class="n">y_test</span><span class="p">)</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">fashion_mnist</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>
<span class="n">X_train_full</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
<span class="n">X_valid</span><span class="p">,</span> <span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="p">[:</span><span class="mi">5000</span><span class="p">],</span> <span class="n">X_train_full</span><span class="p">[</span><span class="mi">5000</span><span class="p">:]</span>
<span class="n">y_valid</span><span class="p">,</span> <span class="n">y_train</span> <span class="o">=</span> <span class="n">y_train_full</span><span class="p">[:</span><span class="mi">5000</span><span class="p">],</span> <span class="n">y_train_full</span><span class="p">[</span><span class="mi">5000</span><span class="p">:]</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="mf">255.</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
<span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1341080501.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">sparse_categorical_crossentropy</span>
<span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">4257548524.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span> <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">sparse_categorical_crossentropy</span>
<span class="ne">----&gt; </span><span class="mi">6</span> <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span> <span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">()]</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">534</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Mean</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>         <span class="n">reduction</span><span class="o">=</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, reduction, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
<span class="ne">--&gt; </span><span class="mi">373</span>     <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>         <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span>     <span class="k">if</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">SUM_OVER_BATCH_SIZE</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;All epochs&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
                    <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
                <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span>
                    <span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                <span class="n">status</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_loss</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrix</span><span class="p">:</span>
                    <span class="n">metric</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                    <span class="n">status</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;val_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">sparse_categorical_accuracy</span><span class="p">(</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrix</span><span class="p">:</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "3fbc73ed7369449ba42d2b12554ee0d0", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "807525607de144da8cdee6a066da3a78", "version_major": 2, "version_minor": 0}
</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1298379325.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                 <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                 <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">()</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">7</span>                     <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                     <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>                     <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="id3">
<h3>b.<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h3>
<p><em>Exercise: Try using a different optimizer with a different learning rate for the upper layers and the lower layers.</em></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">backend</span><span class="o">.</span><span class="n">clear_session</span><span class="p">()</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="n">lower_layers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]),</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">upper_layers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
    <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;softmax&quot;</span><span class="p">),</span>
<span class="p">])</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span><span class="n">lower_layers</span><span class="p">,</span> <span class="n">upper_layers</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1583446227.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">tf</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> 
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">lower_layers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Sequential</span><span class="p">([</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Flatten</span><span class="p">(</span><span class="n">input_shape</span><span class="o">=</span><span class="p">[</span><span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">]),</span>
<span class="g g-Whitespace">      </span><span class="mi">7</span>     <span class="n">layers</span><span class="o">.</span><span class="n">Dense</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s2">&quot;relu&quot;</span><span class="p">),</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">530</span>       <span class="n">result</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span>     <span class="k">finally</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_self_setattr_tracking</span> <span class="o">=</span> <span class="n">previous_value</span>  <span class="c1"># pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/sequential.py</span> in <span class="ni">__init__</span><span class="nt">(self, layers, name)</span>
<span class="g g-Whitespace">    </span><span class="mi">105</span>     <span class="sd">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">106</span><span class="sd">     # Skip the init in FunctionalModel since model doesn&#39;t have input/output yet</span>
<span class="ne">--&gt; </span><span class="mi">107</span><span class="sd">     super(functional.Functional, self).__init__(  # pylint: disable=bad-super-call</span>
<span class="g g-Whitespace">    </span><span class="mi">108</span><span class="sd">         name=name, autocast=False)</span>
<span class="g g-Whitespace">    </span><span class="mi">109</span><span class="sd">     base_layer.keras_api_gauge.get_cell(&#39;Sequential&#39;).set(True)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">__init__</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">287</span><span class="sd">     self._steps_per_execution = None</span>
<span class="g g-Whitespace">    </span><span class="mi">288</span><span class="sd"> </span>
<span class="ne">--&gt; </span><span class="mi">289</span><span class="sd">     self._init_batch_counters()</span>
<span class="g g-Whitespace">    </span><span class="mi">290</span><span class="sd">     self._base_model_initialized = True</span>
<span class="g g-Whitespace">    </span><span class="mi">291</span><span class="sd"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_method_wrapper</span><span class="nt">(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span><span class="sd">     self._self_setattr_tracking = False  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span><span class="sd">     try:</span>
<span class="ne">--&gt; </span><span class="mi">530</span><span class="sd">       result = method(self, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">531</span><span class="sd">     finally:</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span><span class="sd">       self._self_setattr_tracking = previous_value  # pylint: disable=protected-access</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/training.py</span> in <span class="ni">_init_batch_counters</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">295</span><span class="sd">     # `evaluate`, and `predict`.</span>
<span class="g g-Whitespace">    </span><span class="mi">296</span><span class="sd">     agg = tf.VariableAggregation.ONLY_FIRST_REPLICA</span>
<span class="ne">--&gt; </span><span class="mi">297</span><span class="sd">     self._train_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">298</span><span class="sd">     self._test_counter = tf.Variable(0, dtype=&#39;int64&#39;, aggregation=agg)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span><span class="sd">     self._predict_counter = tf.Variable(</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">266</span><span class="sd">       return cls._variable_v1_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span><span class="sd">     elif cls is Variable:</span>
<span class="ne">--&gt; </span><span class="mi">268</span><span class="sd">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="sd">     else:</span>
<span class="g g-Whitespace">    </span><span class="mi">270</span><span class="sd">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v2_call</span><span class="nt">(cls, initial_value, trainable, validate_shape, caching_device, name, variable_def, dtype, import_scope, constraint, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">248</span><span class="sd">     if aggregation is None:</span>
<span class="g g-Whitespace">    </span><span class="mi">249</span><span class="sd">       aggregation = VariableAggregation.NONE</span>
<span class="ne">--&gt; </span><span class="mi">250</span><span class="sd">     return previous_getter(</span>
<span class="g g-Whitespace">    </span><span class="mi">251</span><span class="sd">         initial_value=initial_value,</span>
<span class="g g-Whitespace">    </span><span class="mi">252</span><span class="sd">         trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">241</span><span class="sd">                         shape=None):</span>
<span class="g g-Whitespace">    </span><span class="mi">242</span><span class="sd">     &quot;&quot;&quot;</span><span class="n">Call</span> <span class="n">on</span> <span class="n">Variable</span> <span class="n">class</span><span class="o">.</span> <span class="n">Useful</span> <span class="n">to</span> <span class="n">force</span> <span class="n">the</span> <span class="n">signature</span><span class="o">.</span><span class="s2">&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">243</span><span class="s2">     previous_getter = lambda **kws: default_variable_creator_v2(None, **kws)</span>
<span class="g g-Whitespace">    </span><span class="mi">244</span><span class="s2">     for _, getter in ops.get_default_graph()._variable_creator_stack:  # pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">245</span><span class="s2">       previous_getter = _make_getter(getter, previous_getter)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator_v2</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2660</span><span class="s2">   shape = kwargs.get(&quot;shape&quot;, None)</span>
<span class="g g-Whitespace">   </span><span class="mi">2661</span><span class="s2"> </span>
<span class="ne">-&gt; </span><span class="mi">2662</span><span class="s2">   return resource_variable_ops.ResourceVariable(</span>
<span class="g g-Whitespace">   </span><span class="mi">2663</span><span class="s2">       initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">2664</span><span class="s2">       trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span><span class="s2">       return cls._variable_v2_call(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span><span class="s2">     else:</span>
<span class="ne">--&gt; </span><span class="mi">270</span><span class="s2">       return super(VariableMetaclass, cls).__call__(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span><span class="s2"> </span>
<span class="g g-Whitespace">    </span><span class="mi">272</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span><span class="s2">       self._init_from_proto(variable_def, import_scope=import_scope)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span><span class="s2">     else:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span><span class="s2">       self._init_from_args(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span><span class="s2">           initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span><span class="s2">           trainable=trainable,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span><span class="s2">           else:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span><span class="s2">             shape = initial_value.shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span><span class="s2">           handle = eager_safe_variable_handle(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span><span class="s2">               initial_value=initial_value,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span><span class="s2">               shape=shape,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span><span class="s2">   &quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span>   <span class="n">dtype</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span>   <span class="k">return</span> <span class="n">_variable_handle_from_shape_and_dtype</span><span class="p">(</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">shared_name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span>                                                <span class="n">graph_mode</span><span class="p">,</span> <span class="n">initial_value</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">is_set</span> <span class="o">=</span> <span class="kc">True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span>     <span class="n">handle_data</span><span class="o">.</span><span class="n">shape_and_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">178</span>         <span class="n">cpp_shape_inference_pb2</span><span class="o">.</span><span class="n">CppShapeInferenceResult</span><span class="o">.</span><span class="n">HandleShapeAndType</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span>             <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="o">.</span><span class="n">as_proto</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="o">.</span><span class="n">as_datatype_enum</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span> 

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">lower_optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">)</span>
<span class="n">upper_optimizer</span> <span class="o">=</span> <span class="n">optimizers</span><span class="o">.</span><span class="n">Nadam</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">n_epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
<span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
<span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">sparse_categorical_crossentropy</span>
<span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">()]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">2588934435.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="n">n_steps</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">X_train</span><span class="p">)</span> <span class="o">//</span> <span class="n">batch_size</span>
<span class="g g-Whitespace">      </span><span class="mi">4</span> <span class="n">loss_fn</span> <span class="o">=</span> <span class="n">losses</span><span class="o">.</span><span class="n">sparse_categorical_crossentropy</span>
<span class="ne">----&gt; </span><span class="mi">5</span> <span class="n">mean_loss</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">Mean</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span> <span class="n">metrix</span> <span class="o">=</span> <span class="p">[</span><span class="n">metrics</span><span class="o">.</span><span class="n">SparseCategoricalAccuracy</span><span class="p">()]</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">532</span> 
<span class="g g-Whitespace">    </span><span class="mi">533</span>   <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">534</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Mean</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>         <span class="n">reduction</span><span class="o">=</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">WEIGHTED_MEAN</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">__init__</span><span class="nt">(self, reduction, name, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">371</span>     <span class="nb">super</span><span class="p">(</span><span class="n">Reduce</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">372</span>     <span class="bp">self</span><span class="o">.</span><span class="n">reduction</span> <span class="o">=</span> <span class="n">reduction</span>
<span class="ne">--&gt; </span><span class="mi">373</span>     <span class="bp">self</span><span class="o">.</span><span class="n">total</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">374</span>         <span class="s1">&#39;total&#39;</span><span class="p">,</span> <span class="n">initializer</span><span class="o">=</span><span class="s1">&#39;zeros&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">375</span>     <span class="k">if</span> <span class="n">reduction</span> <span class="ow">in</span> <span class="p">[</span><span class="n">metrics_utils</span><span class="o">.</span><span class="n">Reduction</span><span class="o">.</span><span class="n">SUM_OVER_BATCH_SIZE</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/metrics.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, aggregation, synchronization, initializer, dtype)</span>
<span class="g g-Whitespace">    </span><span class="mi">310</span> 
<span class="g g-Whitespace">    </span><span class="mi">311</span>     <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">init_scope</span><span class="p">():</span>
<span class="ne">--&gt; </span><span class="mi">312</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Metric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">add_weight</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">313</span>           <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">314</span>           <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer.py</span> in <span class="ni">add_weight</span><span class="nt">(self, name, shape, dtype, initializer, regularizer, trainable, constraint, use_resource, synchronization, aggregation, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">645</span>         <span class="n">caching_device</span> <span class="o">=</span> <span class="kc">None</span>
<span class="g g-Whitespace">    </span><span class="mi">646</span> 
<span class="ne">--&gt; </span><span class="mi">647</span>     <span class="n">variable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_variable_with_custom_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">648</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">649</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/training/tracking/base.py</span> in <span class="ni">_add_variable_with_custom_getter</span><span class="nt">(self, name, shape, dtype, initializer, getter, overwrite, **kwargs_for_getter)</span>
<span class="g g-Whitespace">    </span><span class="mi">811</span>         <span class="c1"># &quot;best effort&quot; to set the initializer with the highest restore UID.</span>
<span class="g g-Whitespace">    </span><span class="mi">812</span>         <span class="n">initializer</span> <span class="o">=</span> <span class="n">checkpoint_initializer</span>
<span class="ne">--&gt; </span><span class="mi">813</span>     <span class="n">new_variable</span> <span class="o">=</span> <span class="n">getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">814</span>         <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">815</span>         <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/keras/engine/base_layer_utils.py</span> in <span class="ni">make_variable</span><span class="nt">(name, shape, dtype, initializer, trainable, caching_device, validate_shape, constraint, use_resource, collections, synchronization, aggregation, partitioner)</span>
<span class="g g-Whitespace">    </span><span class="mi">115</span>   <span class="c1"># However, this breaks legacy (Estimator) checkpoints</span>
<span class="g g-Whitespace">    </span><span class="mi">116</span>   <span class="c1"># because it changes variable names. Remove this when V1 is fully deprecated.</span>
<span class="ne">--&gt; </span><span class="mi">117</span>   <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">compat</span><span class="o">.</span><span class="n">v1</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">118</span>       <span class="n">initial_value</span><span class="o">=</span><span class="n">init_val</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">119</span>       <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">264</span>   <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">265</span>     <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">VariableV1</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">266</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v1_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">267</span>     <span class="k">elif</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="n">Variable</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">_variable_v1_call</span><span class="nt">(cls, initial_value, trainable, collections, validate_shape, caching_device, name, variable_def, dtype, expected_shape, import_scope, constraint, use_resource, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="k">if</span> <span class="n">aggregation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>       <span class="n">aggregation</span> <span class="o">=</span> <span class="n">VariableAggregation</span><span class="o">.</span><span class="n">NONE</span>
<span class="ne">--&gt; </span><span class="mi">212</span>     <span class="k">return</span> <span class="n">previous_getter</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">&lt;lambda&gt;</span><span class="nt">(**kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">203</span>                         <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">204</span>     <span class="sd">&quot;&quot;&quot;Call on Variable class. Useful to force the signature.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">205</span>     <span class="n">previous_getter</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">default_variable_creator</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">getter</span> <span class="ow">in</span> <span class="n">ops</span><span class="o">.</span><span class="n">get_default_graph</span><span class="p">()</span><span class="o">.</span><span class="n">_variable_creator_stack</span><span class="p">:</span>  <span class="c1"># pylint: disable=protected-access</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span>       <span class="n">previous_getter</span> <span class="o">=</span> <span class="n">_make_getter</span><span class="p">(</span><span class="n">getter</span><span class="p">,</span> <span class="n">previous_getter</span><span class="p">)</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variable_scope.py</span> in <span class="ni">default_variable_creator</span><span class="nt">(next_creator, **kwargs)</span>
<span class="g g-Whitespace">   </span><span class="mi">2610</span>   <span class="k">if</span> <span class="n">use_resource</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2611</span>     <span class="n">distribute_strategy</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;distribute_strategy&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2612</span>     <span class="k">return</span> <span class="n">resource_variable_ops</span><span class="o">.</span><span class="n">ResourceVariable</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2613</span>         <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">2614</span>         <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/variables.py</span> in <span class="ni">__call__</span><span class="nt">(cls, *args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">268</span>       <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_variable_v2_call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">269</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">270</span>       <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">VariableMetaclass</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__call__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">271</span> 
<span class="g g-Whitespace">    </span><span class="mi">272</span> 

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">__init__</span><span class="nt">(self, initial_value, trainable, collections, validate_shape, caching_device, name, dtype, variable_def, import_scope, constraint, distribute_strategy, synchronization, aggregation, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1600</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_proto</span><span class="p">(</span><span class="n">variable_def</span><span class="p">,</span> <span class="n">import_scope</span><span class="o">=</span><span class="n">import_scope</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1601</span>     <span class="k">else</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1602</span>       <span class="bp">self</span><span class="o">.</span><span class="n">_init_from_args</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1603</span>           <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1604</span>           <span class="n">trainable</span><span class="o">=</span><span class="n">trainable</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_init_from_args</span><span class="nt">(self, initial_value, trainable, collections, caching_device, name, dtype, constraint, synchronization, aggregation, distribute_strategy, shape)</span>
<span class="g g-Whitespace">   </span><span class="mi">1754</span>           <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">1755</span>             <span class="n">shape</span> <span class="o">=</span> <span class="n">initial_value</span><span class="o">.</span><span class="n">shape</span>
<span class="ne">-&gt; </span><span class="mi">1756</span>           <span class="n">handle</span> <span class="o">=</span> <span class="n">eager_safe_variable_handle</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">1757</span>               <span class="n">initial_value</span><span class="o">=</span><span class="n">initial_value</span><span class="p">,</span>
<span class="g g-Whitespace">   </span><span class="mi">1758</span>               <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">eager_safe_variable_handle</span><span class="nt">(initial_value, shape, shared_name, name, graph_mode)</span>
<span class="g g-Whitespace">    </span><span class="mi">236</span>   <span class="s2">&quot;&quot;&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">237</span><span class="s2">   dtype = initial_value.dtype.base_dtype</span>
<span class="ne">--&gt; </span><span class="mi">238</span><span class="s2">   return _variable_handle_from_shape_and_dtype(shape, dtype, shared_name, name,</span>
<span class="g g-Whitespace">    </span><span class="mi">239</span><span class="s2">                                                graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">240</span><span class="s2"> </span>

<span class="nn">/usr/local/Caskroom/miniconda/base/envs/kaggle/lib/python3.9/site-packages/tensorflow/python/ops/resource_variable_ops.py</span> in <span class="ni">_variable_handle_from_shape_and_dtype</span><span class="nt">(shape, dtype, shared_name, name, graph_mode, initial_value)</span>
<span class="g g-Whitespace">    </span><span class="mi">176</span><span class="s2">     handle_data.is_set = True</span>
<span class="g g-Whitespace">    </span><span class="mi">177</span><span class="s2">     handle_data.shape_and_type.append(</span>
<span class="ne">--&gt; </span><span class="mi">178</span><span class="s2">         cpp_shape_inference_pb2.CppShapeInferenceResult.HandleShapeAndType(</span>
<span class="g g-Whitespace">    </span><span class="mi">179</span><span class="s2">             shape=shape.as_proto(), dtype=dtype.as_datatype_enum))</span>
<span class="g g-Whitespace">    </span><span class="mi">180</span><span class="s2"> </span>

<span class="ne">TypeError</span>: Parameter to MergeFrom() must be instance of same class: expected tensorflow.TensorShapeProto got tensorflow.TensorShapeProto.
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_epochs</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;All epochs&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">epochs</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="n">epochs</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">trange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Epoch </span><span class="si">{</span><span class="n">epoch</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">n_epochs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">steps</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">step</span> <span class="ow">in</span> <span class="n">steps</span><span class="p">:</span>
                <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
                <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">(</span><span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
                    <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
                    <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
                    <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">layers</span><span class="p">,</span> <span class="n">optimizer</span> <span class="ow">in</span> <span class="p">((</span><span class="n">lower_layers</span><span class="p">,</span> <span class="n">lower_optimizer</span><span class="p">),</span>
                                          <span class="p">(</span><span class="n">upper_layers</span><span class="p">,</span> <span class="n">upper_optimizer</span><span class="p">)):</span>
                    <span class="n">gradients</span> <span class="o">=</span> <span class="n">tape</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">layers</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">)</span>
                    <span class="n">optimizer</span><span class="o">.</span><span class="n">apply_gradients</span><span class="p">(</span>
                        <span class="nb">zip</span><span class="p">(</span><span class="n">gradients</span><span class="p">,</span> <span class="n">layers</span><span class="o">.</span><span class="n">trainable_variables</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">tape</span>
                <span class="k">for</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">variable</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">variable</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">variable</span><span class="o">.</span><span class="n">constraint</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
                <span class="n">mean_loss</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
                <span class="n">status</span><span class="p">[</span><span class="s2">&quot;loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_loss</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="n">metrix</span><span class="p">:</span>
                    <span class="n">metric</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
                    <span class="n">status</span><span class="p">[</span><span class="n">metric</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">result</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
                <span class="n">steps</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)</span>
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;val_loss&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">status</span><span class="p">[</span><span class="s2">&quot;val_accuracy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
                <span class="n">metrics</span><span class="o">.</span><span class="n">sparse_categorical_accuracy</span><span class="p">(</span>
                    <span class="n">tf</span><span class="o">.</span><span class="n">constant</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">),</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">steps</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">metric</span> <span class="ow">in</span> <span class="p">[</span><span class="n">mean_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">metrix</span><span class="p">:</span>
            <span class="n">metric</span><span class="o">.</span><span class="n">reset_states</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id": "517f93cec2614622a8152e0a4005d88b", "version_major": 2, "version_minor": 0}
</script><script type="application/vnd.jupyter.widget-view+json">
{"model_id": "389dcbb3d53644a5b528affce79ac63c", "version_major": 2, "version_minor": 0}
</script><div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">NameError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">folders</span><span class="o">/</span><span class="mi">93</span><span class="o">/</span><span class="mi">795</span><span class="n">zm8c93m16_92qkk86t0_r0000gn</span><span class="o">/</span><span class="n">T</span><span class="o">/</span><span class="n">ipykernel_24022</span><span class="o">/</span><span class="mf">1556310410.</span><span class="n">py</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>                 <span class="n">X_batch</span><span class="p">,</span> <span class="n">y_batch</span> <span class="o">=</span> <span class="n">random_batch</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>                 <span class="k">with</span> <span class="n">tf</span><span class="o">.</span><span class="n">GradientTape</span><span class="p">(</span><span class="n">persistent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">tape</span><span class="p">:</span>
<span class="ne">----&gt; </span><span class="mi">7</span>                     <span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">X_batch</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span>                     <span class="n">main_loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">reduce_mean</span><span class="p">(</span><span class="n">loss_fn</span><span class="p">(</span><span class="n">y_batch</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span>                     <span class="n">loss</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">add_n</span><span class="p">([</span><span class="n">main_loss</span><span class="p">]</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">losses</span><span class="p">)</span>

<span class="ne">NameError</span>: name &#39;model&#39; is not defined
</pre></div>
</div>
</div>
</div>
</div>
</div>
</div>


<script type="application/vnd.jupyter.widget-state+json">
{"state": {"01b4b3afe6bf49f9b69a09cccee0dc4e": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "0891415fd5bb48a49a79bac9ea46dccb": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_0f36eaf6fab84af5b2737e04d1206ebf", "placeholder": "\u200b", "style": "IPY_MODEL_62f289703e0e43d08c38428b66710719", "value": " 0/362 [00:00&lt;?, ?it/s]"}}, "09dc835d6e044ba792d47a3ff8611d7c": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "0c60cebe60324ffe9ea221db4d21683c": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "0f36eaf6fab84af5b2737e04d1206ebf": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "11b9b3ac91814a90b022fe27b3b1e575": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_fc5880455fb147a99e9867fca585c441", "placeholder": "\u200b", "style": "IPY_MODEL_82a96c05054e4c77bae89c99fbd5caf8", "value": " 0/5 [00:00&lt;?, ?it/s]"}}, "153dc34c7c2c44dc91be34b94b8d777c": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "1b5f9d92cfa042bbbeecf6b18756fd3f": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "2f93ab09021f4c03b79f877057b08ddf": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_c3517598f70c43da87cc07e35c853e87", "max": 362.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_09dc835d6e044ba792d47a3ff8611d7c", "value": 0.0}}, "36a63aade8b84715b823a19c34ab690c": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "389dcbb3d53644a5b528affce79ac63c": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_60a095dff44542dc89df87511d5c6b95", "IPY_MODEL_ab17ba8f0fbc4b9da043555a93de9e33", "IPY_MODEL_c2afd21db678447092adcaca9ddf6087"], "layout": "IPY_MODEL_fad0b087531441619f5b8b20198ff5f2"}}, "3c91f5f7f7114293bd31483e869d26bb": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_d486c13d9c4d404cbb190dfeee417de9", "max": 1718.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_4326409e30884c35be65ec0d4e32f978", "value": 0.0}}, "3fbc73ed7369449ba42d2b12554ee0d0": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_9d09741b13ed4303b1a506bafe8c528d", "IPY_MODEL_d920a72390fa4927be61d83137227d18", "IPY_MODEL_11b9b3ac91814a90b022fe27b3b1e575"], "layout": "IPY_MODEL_4fdeb3dbe975401ea8788ecfb3d5ff62"}}, "4272806c2bf94b7ca8ed92fa7a1d9327": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_cbea7342cc714b908566474bccb07ec0", "max": 5.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_efa64652c21e482883e2732be3f4129e", "value": 0.0}}, "4326409e30884c35be65ec0d4e32f978": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "45d1effcf54b433facf7f6d574bd3191": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_153dc34c7c2c44dc91be34b94b8d777c", "placeholder": "\u200b", "style": "IPY_MODEL_83a553d643f1429ba9ea545fd91df09d", "value": "All epochs:   0%"}}, "4a4504b908f649cb9cc70b9a81ce7aab": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "4d242c683dca4e2fa0f161c15f87be8b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "4fdeb3dbe975401ea8788ecfb3d5ff62": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "50db290c9ab746a89bfebf1933e1cb7b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "517f93cec2614622a8152e0a4005d88b": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_45d1effcf54b433facf7f6d574bd3191", "IPY_MODEL_4272806c2bf94b7ca8ed92fa7a1d9327", "IPY_MODEL_769ca6b7914f49e19c2137ca64561350"], "layout": "IPY_MODEL_9958f2b51c9f4b74aee15e7eb43d225b"}}, "5b7a351c851045d7821c10c89be42111": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_ba91a178a09640448d5056570ffc3f9b", "placeholder": "\u200b", "style": "IPY_MODEL_4a4504b908f649cb9cc70b9a81ce7aab", "value": "Epoch 1/5:   0%"}}, "5e727bf2cb044730bbdda14ce0ca632b": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_9d850caf90d5469a8404ed094f3f69b5", "max": 5.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_0c60cebe60324ffe9ea221db4d21683c", "value": 0.0}}, "60a095dff44542dc89df87511d5c6b95": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_50db290c9ab746a89bfebf1933e1cb7b", "placeholder": "\u200b", "style": "IPY_MODEL_fa9620f55bc34f99869672a5396a9d19", "value": "Epoch 1/5:   0%"}}, "62f289703e0e43d08c38428b66710719": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "67dd698b98de4f0cb47dc5e28a94c8b7": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_f49fb52a46914aa8934d465280bfe635", "placeholder": "\u200b", "style": "IPY_MODEL_f3b97f84d8d548c28f5a196e1b42645d", "value": "All epochs:   0%"}}, "6accbe827c3f440fa71605cd8ebfaadf": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_af995099279d471e8d76e23e721ea8c6", "IPY_MODEL_2f93ab09021f4c03b79f877057b08ddf", "IPY_MODEL_0891415fd5bb48a49a79bac9ea46dccb"], "layout": "IPY_MODEL_97295317245543a4bc6828cd5d66c2c5"}}, "769ca6b7914f49e19c2137ca64561350": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_dbf544fec17443acbfc4e27ce6a38ded", "placeholder": "\u200b", "style": "IPY_MODEL_d7d3553863084ff8890e13faf5ba21c7", "value": " 0/5 [00:00&lt;?, ?it/s]"}}, "80493bd07aee4e9aa4edd127b5ab3516": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "807525607de144da8cdee6a066da3a78": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_5b7a351c851045d7821c10c89be42111", "IPY_MODEL_3c91f5f7f7114293bd31483e869d26bb", "IPY_MODEL_bd1e9ae477c34f15a7a4901ce6930f08"], "layout": "IPY_MODEL_bace4bf7ee8b4291b065c3689d9ccd04"}}, "82a96c05054e4c77bae89c99fbd5caf8": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "83a553d643f1429ba9ea545fd91df09d": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "88a67100117944f4ac9228960fd9f885": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HBoxModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HBoxModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HBoxView", "box_style": "", "children": ["IPY_MODEL_67dd698b98de4f0cb47dc5e28a94c8b7", "IPY_MODEL_5e727bf2cb044730bbdda14ce0ca632b", "IPY_MODEL_a6daeacec14b40e6ac46a87d9d097ef6"], "layout": "IPY_MODEL_dcf8628c85484ea6b95d923bd3503bbc"}}, "8959ea623dc04757bb389524443acfbf": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "97295317245543a4bc6828cd5d66c2c5": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "9958f2b51c9f4b74aee15e7eb43d225b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "9d09741b13ed4303b1a506bafe8c528d": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_fd3f7f08c0a34c6aa33dac642c12405b", "placeholder": "\u200b", "style": "IPY_MODEL_e04a4918f8d7407e92f1535caec0650d", "value": "All epochs:   0%"}}, "9d850caf90d5469a8404ed094f3f69b5": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "a6daeacec14b40e6ac46a87d9d097ef6": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_eb6cc24a38e047328f2d015df89eab08", "placeholder": "\u200b", "style": "IPY_MODEL_8959ea623dc04757bb389524443acfbf", "value": " 0/5 [00:00&lt;?, ?it/s]"}}, "ab17ba8f0fbc4b9da043555a93de9e33": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_80493bd07aee4e9aa4edd127b5ab3516", "max": 1718.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_1b5f9d92cfa042bbbeecf6b18756fd3f", "value": 0.0}}, "af995099279d471e8d76e23e721ea8c6": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_f3bcf82e02a34a45bae1d36fa3017081", "placeholder": "\u200b", "style": "IPY_MODEL_d27792abee2d47c38f90e900cd3f3c94", "value": "Epoch 1/5:   0%"}}, "ba91a178a09640448d5056570ffc3f9b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "bace4bf7ee8b4291b065c3689d9ccd04": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "bd1e9ae477c34f15a7a4901ce6930f08": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_4d242c683dca4e2fa0f161c15f87be8b", "placeholder": "\u200b", "style": "IPY_MODEL_36a63aade8b84715b823a19c34ab690c", "value": " 0/1718 [00:00&lt;?, ?it/s]"}}, "befe29a88aec45c7bbcae5f3872a78f3": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "c2afd21db678447092adcaca9ddf6087": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "HTMLModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "HTMLModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "HTMLView", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_dedbde3731804302a134c1ba8439337b", "placeholder": "\u200b", "style": "IPY_MODEL_01b4b3afe6bf49f9b69a09cccee0dc4e", "value": " 0/1718 [00:00&lt;?, ?it/s]"}}, "c3517598f70c43da87cc07e35c853e87": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "cbea7342cc714b908566474bccb07ec0": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "d27792abee2d47c38f90e900cd3f3c94": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "d486c13d9c4d404cbb190dfeee417de9": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "d7d3553863084ff8890e13faf5ba21c7": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "d8b80b6488f4460b8302b804d173d9fb": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "d920a72390fa4927be61d83137227d18": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "FloatProgressModel", "state": {"_dom_classes": [], "_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "FloatProgressModel", "_view_count": null, "_view_module": "@jupyter-widgets/controls", "_view_module_version": "1.5.0", "_view_name": "ProgressView", "bar_style": "danger", "description": "", "description_tooltip": null, "layout": "IPY_MODEL_befe29a88aec45c7bbcae5f3872a78f3", "max": 5.0, "min": 0.0, "orientation": "horizontal", "style": "IPY_MODEL_d8b80b6488f4460b8302b804d173d9fb", "value": 0.0}}, "dbf544fec17443acbfc4e27ce6a38ded": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dcf8628c85484ea6b95d923bd3503bbc": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "dedbde3731804302a134c1ba8439337b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "e04a4918f8d7407e92f1535caec0650d": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "eb6cc24a38e047328f2d015df89eab08": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "efa64652c21e482883e2732be3f4129e": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "ProgressStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "ProgressStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "bar_color": null, "description_width": ""}}, "f3b97f84d8d548c28f5a196e1b42645d": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "f3bcf82e02a34a45bae1d36fa3017081": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "f49fb52a46914aa8934d465280bfe635": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "fa9620f55bc34f99869672a5396a9d19": {"model_module": "@jupyter-widgets/controls", "model_module_version": "1.5.0", "model_name": "DescriptionStyleModel", "state": {"_model_module": "@jupyter-widgets/controls", "_model_module_version": "1.5.0", "_model_name": "DescriptionStyleModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "StyleView", "description_width": ""}}, "fad0b087531441619f5b8b20198ff5f2": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "fc5880455fb147a99e9867fca585c441": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}, "fd3f7f08c0a34c6aa33dac642c12405b": {"model_module": "@jupyter-widgets/base", "model_module_version": "1.2.0", "model_name": "LayoutModel", "state": {"_model_module": "@jupyter-widgets/base", "_model_module_version": "1.2.0", "_model_name": "LayoutModel", "_view_count": null, "_view_module": "@jupyter-widgets/base", "_view_module_version": "1.2.0", "_view_name": "LayoutView", "align_content": null, "align_items": null, "align_self": null, "border": null, "bottom": null, "display": null, "flex": null, "flex_flow": null, "grid_area": null, "grid_auto_columns": null, "grid_auto_flow": null, "grid_auto_rows": null, "grid_column": null, "grid_gap": null, "grid_row": null, "grid_template_areas": null, "grid_template_columns": null, "grid_template_rows": null, "height": null, "justify_content": null, "justify_items": null, "left": null, "margin": null, "max_height": null, "max_width": null, "min_height": null, "min_width": null, "object_fit": null, "object_position": null, "order": null, "overflow": null, "overflow_x": null, "overflow_y": null, "padding": null, "right": null, "top": null, "visibility": null, "width": null}}}, "version_major": 2, "version_minor": 0}
</script>


    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./handson-dl"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="101-intro-keras.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Introduction to Artificial Neural Networks with Keras</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="../probability/01-Probability-and-Counting.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Probability and Counting</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By integzz<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>